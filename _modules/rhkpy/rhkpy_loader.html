<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>rhkpy.rhkpy_loader &mdash; rhkpy 2023.08.10 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            rhkpy
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../intro.html#installation">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../intro.html#examples">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rhkpy.html">rhkpy package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">rhkpy</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">rhkpy</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">rhkpy.rhkpy_loader</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for rhkpy.rhkpy_loader</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">pl</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
<span class="kn">import</span> <span class="nn">re</span>

<span class="c1"># import load from spym</span>
<span class="kn">from</span> <span class="nn">spym.io</span> <span class="kn">import</span> <span class="n">load</span>

<span class="c1">## Using the old loader</span>
<span class="kn">from</span> <span class="nn">spym.io</span> <span class="kn">import</span> <span class="n">rhksm4</span>

<span class="c1">## flatten and plane fitting</span>
<span class="kn">from</span> <span class="nn">spym.process.level</span> <span class="kn">import</span> <span class="n">align</span>
<span class="kn">from</span> <span class="nn">spym.process.level</span> <span class="kn">import</span> <span class="n">plane</span>

<span class="kn">from</span> <span class="nn">.rhkpy_process</span> <span class="kn">import</span> <span class="o">*</span>

<div class="viewcode-block" id="rhkdata"><a class="viewcode-back" href="../../rhkpy.html#rhkpy.rhkpy_loader.rhkdata">[docs]</a><span class="k">class</span> <span class="nc">rhkdata</span><span class="p">:</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	A container for the xarray based structure of the RHK data.</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">repetitions</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">alternate</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">datatype</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">spectype</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

		<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">alternate</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
			<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;alternate needs to be a bool variable: True or False. Default is True&quot;</span><span class="p">)</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>

		<span class="c1"># Boolean value, True if alternate scan directions is turned on</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">alternate</span> <span class="o">=</span> <span class="n">alternate</span>

		<span class="c1"># Load the data using spym</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">spymdata</span> <span class="o">=</span> <span class="n">load_spym</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>

		<span class="c1"># check software version. Not tested for MinorVer &lt; 6</span>
		<span class="n">l</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spymdata</span><span class="p">[</span><span class="n">l</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_MinorVer&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">:</span>
			<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;stmdatastruct not tested for RHK Rev version &lt; 6. Some things might not work as expected.&#39;</span><span class="p">)</span>

		<span class="c1"># check type of data and spectra contained in the file, if no type is specified</span>
		<span class="k">if</span> <span class="n">datatype</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">datatype</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectype</span> <span class="o">=</span> <span class="n">_checkdatatype</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">datatype</span> <span class="o">!=</span> <span class="s1">&#39;map&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">datatype</span> <span class="o">!=</span> <span class="s1">&#39;line&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">datatype</span> <span class="o">!=</span> <span class="s1">&#39;spec&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">datatype</span> <span class="o">!=</span> <span class="s1">&#39;image&#39;</span><span class="p">):</span>
				<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;datatype must be either: map, line, spec or image&#39;</span><span class="p">)</span>
				<span class="k">return</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">datatype</span> <span class="o">=</span> <span class="n">datatype</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">spectype</span> <span class="o">=</span> <span class="n">spectype</span>

		<span class="c1"># number of spectra at a tip position</span>
		<span class="c1"># default value is 0, if this is changed, the code will use the given value, othewise it will try to infer the number of repetitions from the number of identical tip positions</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">datatype</span> <span class="o">!=</span> <span class="s1">&#39;image&#39;</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">repetitions</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
				<span class="c1"># overwrite the default value and the value inferred from tip coordinates</span>
				<span class="c1"># check if parameters passed to the class are valid</span>
				<span class="k">if</span> <span class="n">repetitions</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
					<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;repetitions needs to be an integer, with a value of 1 or above. Default is 1&quot;</span><span class="p">)</span>
				<span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">repetitions</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
					<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;repetitions needs to be an integer. Default is 1&quot;</span><span class="p">)</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">repetitions</span> <span class="o">=</span> <span class="n">repetitions</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="c1"># determine the number of repetitions from the number of indentical tip coordinates in the beginning of RHK_SpecDrift_Xcoord</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">repetitions</span> <span class="o">=</span> <span class="n">_checkrepetitions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">repetitions</span> <span class="o">=</span> <span class="n">repetitions</span>

		<span class="c1"># load data into xarray, for all data types</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">datatype</span> <span class="o">==</span> <span class="s1">&#39;map&#39;</span><span class="p">:</span>
			<span class="bp">self</span> <span class="o">=</span> <span class="n">_load_specmap</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
		<span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">datatype</span> <span class="o">==</span> <span class="s1">&#39;line&#39;</span><span class="p">:</span>
			<span class="bp">self</span> <span class="o">=</span> <span class="n">_load_line</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
		<span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">datatype</span> <span class="o">==</span> <span class="s1">&#39;spec&#39;</span><span class="p">:</span>
			<span class="bp">self</span> <span class="o">=</span> <span class="n">_load_spec</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
		<span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">datatype</span> <span class="o">==</span> <span class="s1">&#39;image&#39;</span><span class="p">:</span>
			<span class="bp">self</span> <span class="o">=</span> <span class="n">_load_image</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

<div class="viewcode-block" id="rhkdata.print_info"><a class="viewcode-back" href="../../rhkpy.html#rhkpy.rhkpy_loader.rhkdata.print_info">[docs]</a>	<span class="k">def</span> <span class="nf">print_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;List the variables and functions of the :class:`rhkdata` instance.</span>
<span class="sd">		&quot;&quot;&quot;</span>		
		<span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
			<span class="nb">print</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
		<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">spymdata:&#39;</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spymdata</span><span class="p">:</span>
			<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span></div>

<div class="viewcode-block" id="rhkdata.specpos"><a class="viewcode-back" href="../../rhkpy.html#rhkpy.rhkpy_loader.rhkdata.specpos">[docs]</a>	<span class="k">def</span> <span class="nf">specpos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">repetitions</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zscandir</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>		
		<span class="c1"># plot the positions of spectra on a topography image</span>
		<span class="k">return</span> <span class="n">plot_spec_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">repetitions</span><span class="o">=</span><span class="n">repetitions</span><span class="p">,</span> <span class="n">zscandir</span><span class="o">=</span><span class="n">zscandir</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="n">z</span><span class="p">)</span></div></div>


<span class="k">def</span> <span class="nf">_checkrepetitions</span><span class="p">(</span><span class="n">stmdata_object</span><span class="p">):</span>
	<span class="n">coordlist</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_SpecDrift_Xcoord&#39;</span><span class="p">]</span>
	<span class="n">reps</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="k">for</span> <span class="n">coo</span> <span class="ow">in</span> <span class="n">coordlist</span><span class="p">:</span>
		<span class="k">if</span> <span class="n">coo</span> <span class="o">==</span> <span class="n">coordlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
			<span class="n">reps</span> <span class="o">+=</span> <span class="mi">1</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">break</span>
	<span class="n">reps</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">reps</span> <span class="o">/</span> <span class="p">(</span><span class="n">stmdata_object</span><span class="o">.</span><span class="n">alternate</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
	<span class="k">return</span> <span class="n">reps</span>

<span class="k">def</span> <span class="nf">_checkdatatype</span><span class="p">(</span><span class="n">stmdata_object</span><span class="p">):</span>
	<span class="c1"># check if the list of keys in the spym data contain &#39;Current&#39;</span>
	<span class="c1"># If yes, it is not a pure topo image</span>
	<span class="n">l</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
	<span class="k">if</span> <span class="s1">&#39;Current&#39;</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>
		<span class="c1"># it&#39;s a single spec, line spec or map</span>
		<span class="k">if</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="p">[</span><span class="s1">&#39;Current&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_PageType&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">38</span><span class="p">:</span>
			<span class="n">stmdata_object</span><span class="o">.</span><span class="n">datatype</span> <span class="o">=</span> <span class="s1">&#39;spec&#39;</span>
			<span class="c1"># determine if it&#39;s Iz or dI/dV</span>
			<span class="k">if</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="p">[</span><span class="s1">&#39;Current&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_LineType&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">7</span><span class="p">:</span>
				<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectype</span> <span class="o">=</span> <span class="s1">&#39;iv&#39;</span>
			<span class="k">elif</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="p">[</span><span class="s1">&#39;Current&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_LineType&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">8</span><span class="p">:</span>
				<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectype</span> <span class="o">=</span> <span class="s1">&#39;iz&#39;</span>
		<span class="k">elif</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="p">[</span><span class="s1">&#39;Current&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_PageType&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">16</span><span class="p">:</span>
			<span class="c1"># this can be either a line spectrum or a map</span>
			<span class="c1"># decide based on the aspect ratio of the spectroscopy tip positions</span>
			<span class="n">xcoo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="p">[</span><span class="s1">&#39;Current&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_SpecDrift_Xcoord&#39;</span><span class="p">])</span>
			<span class="n">ycoo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="p">[</span><span class="s1">&#39;Current&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_SpecDrift_Ycoord&#39;</span><span class="p">])</span>
			<span class="k">if</span> <span class="n">_aspect_ratio</span><span class="p">(</span><span class="n">xcoo</span><span class="p">,</span> <span class="n">ycoo</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
				<span class="n">stmdata_object</span><span class="o">.</span><span class="n">datatype</span> <span class="o">=</span> <span class="s1">&#39;line&#39;</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">stmdata_object</span><span class="o">.</span><span class="n">datatype</span> <span class="o">=</span> <span class="s1">&#39;map&#39;</span>
			<span class="c1"># determine if it&#39;s Iz or dI/dV</span>
			<span class="k">if</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="p">[</span><span class="s1">&#39;Current&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_LineType&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">7</span><span class="p">:</span>
				<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectype</span> <span class="o">=</span> <span class="s1">&#39;iv&#39;</span>
			<span class="k">elif</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="p">[</span><span class="s1">&#39;Current&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_LineType&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">8</span><span class="p">:</span>
				<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectype</span> <span class="o">=</span> <span class="s1">&#39;iz&#39;</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="n">stmdata_object</span><span class="o">.</span><span class="n">datatype</span> <span class="o">=</span> <span class="s1">&#39;image&#39;</span>
		<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectype</span> <span class="o">=</span> <span class="kc">None</span>
	
	<span class="k">return</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">datatype</span><span class="p">,</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectype</span>


<span class="k">def</span> <span class="nf">_aspect_ratio</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="n">xy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">eigvals</span><span class="p">,</span> <span class="n">eigvecs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eig</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">xy</span><span class="p">))</span>
    <span class="n">center</span> <span class="o">=</span> <span class="n">xy</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">val</span><span class="p">,</span> <span class="n">vec</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">eigvals</span><span class="p">,</span> <span class="n">eigvecs</span><span class="o">.</span><span class="n">T</span><span class="p">):</span>
        <span class="n">val</span> <span class="o">*=</span> <span class="mi">2</span>
        <span class="n">xcov</span><span class="p">,</span><span class="n">ycov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">center</span> <span class="o">+</span> <span class="n">val</span> <span class="o">*</span> <span class="n">vec</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">center</span> <span class="o">-</span> <span class="n">val</span> <span class="o">*</span> <span class="n">vec</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
    <span class="n">aspect</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">eigvals</span><span class="p">)</span> <span class="o">/</span> <span class="nb">min</span><span class="p">(</span><span class="n">eigvals</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">aspect</span>


<span class="k">def</span> <span class="nf">_get_filename</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
	<span class="c1"># If the string ends with a slash or backslash, remove it first</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;/</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># Then, match any character other than backslash or slash until the end of the string</span>
    <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[^/</span><span class="se">\\</span><span class="s1">]+$&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="n">match</span> <span class="k">else</span> <span class="kc">None</span>


<span class="k">def</span> <span class="nf">_load_specmap</span><span class="p">(</span><span class="n">stmdata_object</span><span class="p">):</span>
	<span class="c1"># total number of spectra in one postion of the tip</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">numberofspectra</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">stmdata_object</span><span class="o">.</span><span class="n">alternate</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">stmdata_object</span><span class="o">.</span><span class="n">repetitions</span><span class="p">)</span>
	<span class="c1"># load the image</span>
	<span class="n">stmdata_object</span> <span class="o">=</span> <span class="n">_load_image</span><span class="p">(</span><span class="n">stmdata_object</span><span class="p">)</span>

	<span class="c1"># decide if it&#39;s a dI/dV or I(z) map</span>
	<span class="k">if</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectype</span> <span class="o">==</span> <span class="s1">&#39;iv&#39;</span><span class="p">:</span>
		<span class="c1"># create a DataSet, containing the LIA and Current maps, with appropriate position coordinates</span>
		<span class="n">stmdata_object</span> <span class="o">=</span> <span class="n">_xr_map_iv</span><span class="p">(</span><span class="n">stmdata_object</span><span class="p">)</span>
		<span class="c1"># add metadata to the xarray</span>
		<span class="n">stmdata_object</span> <span class="o">=</span> <span class="n">_add_map_metadata</span><span class="p">(</span><span class="n">stmdata_object</span><span class="p">)</span>
	<span class="k">elif</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectype</span> <span class="o">==</span> <span class="s1">&#39;iz&#39;</span><span class="p">:</span>
		<span class="c1"># create xarray Dataset</span>
		<span class="n">stmdata_object</span> <span class="o">=</span> <span class="n">_xr_map_iz</span><span class="p">(</span><span class="n">stmdata_object</span><span class="p">)</span>
		<span class="c1"># add metadata to the xarray</span>
		<span class="n">stmdata_object</span> <span class="o">=</span> <span class="n">_add_map_metadata</span><span class="p">(</span><span class="n">stmdata_object</span><span class="p">)</span>
	<span class="k">return</span> <span class="n">stmdata_object</span>


<span class="k">def</span> <span class="nf">_load_line</span><span class="p">(</span><span class="n">stmdata_object</span><span class="p">):</span>
	<span class="c1"># total number of spectra in one postion of the tip</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">numberofspectra</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">stmdata_object</span><span class="o">.</span><span class="n">alternate</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">stmdata_object</span><span class="o">.</span><span class="n">repetitions</span><span class="p">)</span>
	<span class="c1"># load the image data</span>
	<span class="n">stmdata_object</span> <span class="o">=</span> <span class="n">_load_image</span><span class="p">(</span><span class="n">stmdata_object</span><span class="p">)</span>

	<span class="c1"># decide if it&#39;s a dI/dV or I(z) line</span>
	<span class="k">if</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectype</span> <span class="o">==</span> <span class="s1">&#39;iv&#39;</span><span class="p">:</span>
		<span class="n">stmdata_object</span> <span class="o">=</span> <span class="n">_xr_line_iv</span><span class="p">(</span><span class="n">stmdata_object</span><span class="p">)</span>
		<span class="n">stmdata_object</span> <span class="o">=</span> <span class="n">_add_line_metadata</span><span class="p">(</span><span class="n">stmdata_object</span><span class="p">)</span>
	<span class="k">elif</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectype</span> <span class="o">==</span> <span class="s1">&#39;iz&#39;</span><span class="p">:</span>
		<span class="n">stmdata_object</span> <span class="o">=</span> <span class="n">_xr_line_iz</span><span class="p">(</span><span class="n">stmdata_object</span><span class="p">)</span>
		<span class="n">stmdata_object</span> <span class="o">=</span> <span class="n">_add_spec_metadata</span><span class="p">(</span><span class="n">stmdata_object</span><span class="p">)</span>
	<span class="k">return</span> <span class="n">stmdata_object</span>


<span class="k">def</span> <span class="nf">_load_spec</span><span class="p">(</span><span class="n">stmdata_object</span><span class="p">):</span>
	<span class="c1"># in this case the total number of spectra can be inferred</span>
	<span class="c1"># total number of spectra in one postion of the tip</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">repetitions</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">stmdata_object</span><span class="o">.</span><span class="n">alternate</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">numberofspectra</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">stmdata_object</span><span class="o">.</span><span class="n">alternate</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">stmdata_object</span><span class="o">.</span><span class="n">repetitions</span><span class="p">)</span>

	<span class="c1"># decide if it&#39;s a dI/dV or I(z) spec</span>
	<span class="k">if</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectype</span> <span class="o">==</span> <span class="s1">&#39;iv&#39;</span><span class="p">:</span>
		<span class="n">stmdata_object</span> <span class="o">=</span> <span class="n">_xr_spec_iv</span><span class="p">(</span><span class="n">stmdata_object</span><span class="p">)</span>
		<span class="n">stmdata_object</span> <span class="o">=</span> <span class="n">_add_spec_metadata</span><span class="p">(</span><span class="n">stmdata_object</span><span class="p">)</span>
	<span class="k">elif</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectype</span> <span class="o">==</span> <span class="s1">&#39;iz&#39;</span><span class="p">:</span>
		<span class="n">stmdata_object</span> <span class="o">=</span> <span class="n">_xr_spec_iz</span><span class="p">(</span><span class="n">stmdata_object</span><span class="p">)</span>
		<span class="n">stmdata_object</span> <span class="o">=</span> <span class="n">_add_spec_metadata</span><span class="p">(</span><span class="n">stmdata_object</span><span class="p">)</span>
	<span class="k">return</span> <span class="n">stmdata_object</span>


<span class="k">def</span> <span class="nf">_load_image</span><span class="p">(</span><span class="n">stmdata_object</span><span class="p">):</span>
	<span class="c1"># load the image data</span>
	<span class="n">stmdata_object</span> <span class="o">=</span> <span class="n">_xr_image</span><span class="p">(</span><span class="n">stmdata_object</span><span class="p">)</span>
	<span class="c1"># add metadata</span>
	<span class="n">stmdata_object</span> <span class="o">=</span> <span class="n">_add_image_metadata</span><span class="p">(</span><span class="n">stmdata_object</span><span class="p">)</span>
	<span class="k">return</span> <span class="n">stmdata_object</span>


<span class="k">def</span> <span class="nf">_xr_map_iv</span><span class="p">(</span><span class="n">stmdata_object</span><span class="p">):</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	TODO need to change spectrum rearranging for the case where alternate is False</span>

<span class="sd">	Create a DataSet containing the Lock-In (LIA) and Current spectroscopy data</span>
<span class="sd">	Use the absolute values of the tip positions as coordinates</span>

<span class="sd">	In spym the spectroscopy data is loaded into an array,</span>
<span class="sd">	which has axis=0 the number of datapoints in the spectra</span>
<span class="sd">	and axis=1 the number of spectra in total.</span>

<span class="sd">	When rearranging, the number of repetitions within each tip position is assumed to be 1</span>
<span class="sd">	and alternate scan direction is assumed to be turned on.</span>
<span class="sd">	These options can be changed by the parameters, `repetitions` and `alternate`</span>
<span class="sd">	&quot;&quot;&quot;</span>

	<span class="c1"># extract the numpy array containing the LIA data from the spym object</span>
	<span class="n">specarray</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">LIA_Current</span><span class="o">.</span><span class="n">data</span>
	<span class="c1"># extract the numpy array containing the Current data from the spym object</span>
	<span class="n">currentarray</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">data</span>

	<span class="c1"># total number of spectra in one postion of the tip</span>
	<span class="n">numberofspectra</span> <span class="o">=</span> <span class="p">(</span><span class="n">stmdata_object</span><span class="o">.</span><span class="n">alternate</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">stmdata_object</span><span class="o">.</span><span class="n">repetitions</span>
	<span class="c1"># size of the map in mapsize x mapsize</span>
	<span class="n">mapsize</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">specarray</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">numberofspectra</span><span class="p">))</span>

	<span class="c1"># reshape LIA data</span>
	<span class="c1"># collect all spectra measured in the same `X, Y` coordinate into an axis (last) of an array.</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">specarray</span><span class="p">,</span> <span class="p">(</span><span class="n">specarray</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">numberofspectra</span><span class="p">),</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">)</span>
	<span class="c1"># Every other spectrum is a forward and backward scan in bias sweep. Separate the forward and backward scans into differing arrays by slicing.</span>
	<span class="c1"># These are all the forward and backward bias sweep spectra, arranged along axis=1, with axis=2 being the repetitions</span>
	<span class="n">spec_fw</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>
	<span class="n">spec_bw</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>
	<span class="c1"># reshape the forward and backward parts into a map</span>
	<span class="n">speccmap_fw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">spec_fw</span><span class="p">,</span> <span class="p">(</span><span class="n">spec_fw</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mapsize</span><span class="p">,</span> <span class="n">mapsize</span><span class="p">,</span> <span class="n">spec_fw</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">)</span>
	<span class="n">speccmap_bw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">spec_bw</span><span class="p">,</span> <span class="p">(</span><span class="n">spec_bw</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mapsize</span><span class="p">,</span> <span class="n">mapsize</span><span class="p">,</span> <span class="n">spec_bw</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">)</span>
	
	<span class="c1"># The last axis (in this case with length of 1) contains the repeated scans in one particular pixel.</span>
	<span class="c1"># If the `repetitions` variable is set to greater than 1, this will contains the repeated spectra within an `X, Y` pixel.</span>
	<span class="c1"># The array needs to be flipped along axis = 1 (the &quot;x&quot; axis in the topography image) to fit with the data read by the ASCII method</span>
	
	<span class="n">liafw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">speccmap_fw</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
	<span class="n">liabw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">speccmap_bw</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

	<span class="c1"># reshape Current data</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">currentarray</span><span class="p">,</span> <span class="p">(</span><span class="n">currentarray</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">numberofspectra</span><span class="p">),</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">)</span>
	<span class="c1"># Every other spectrum is a forward and backward scan in bias sweep. Separate the forward and backward scans into differing arrays by slicing.</span>
	<span class="c1"># These are all the forward and backward bias sweep spectra, arranged along axis=1, with axis=2 being the repetitions</span>
	<span class="n">current_fw</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>
	<span class="n">current_bw</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>
	<span class="c1"># reshape the forward and backward parts into a map</span>
	<span class="n">currentmap_fw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">current_fw</span><span class="p">,</span> <span class="p">(</span><span class="n">current_fw</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mapsize</span><span class="p">,</span> <span class="n">mapsize</span><span class="p">,</span> <span class="n">current_fw</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">)</span>
	<span class="n">currentmap_bw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">current_bw</span><span class="p">,</span> <span class="p">(</span><span class="n">current_bw</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mapsize</span><span class="p">,</span> <span class="n">mapsize</span><span class="p">,</span> <span class="n">current_bw</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">)</span>
	
	<span class="c1"># The last axis (in this case with length of 1) contains the repeated scans in one particular pixel.</span>
	<span class="c1"># If the `repetitions` variable is set to greater than 1, this will contains the repeated spectra within an `X, Y` pixel.</span>
	<span class="c1"># The array needs to be flipped along axis = 1 (the &quot;x&quot; axis in the topography image) to fit with the data read by the ASCII method</span>
	
	<span class="n">currentfw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">currentmap_fw</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
	<span class="n">currentbw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">currentmap_bw</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>	

	<span class="c1"># Coordinates of the spectroscopy map</span>
	
	<span class="c1"># &#39;RHK_SpecDrift_Xcoord&#39; are the coordinates of the spectra.</span>
	<span class="c1"># This contains the coordinates in the order that the spectra are in. </span>
	<span class="n">xcoo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">LIA_Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_SpecDrift_Xcoord&#39;</span><span class="p">])</span>
	<span class="n">ycoo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">LIA_Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_SpecDrift_Ycoord&#39;</span><span class="p">])</span>
	
	<span class="c1"># reshaping the coordinates similarly to the spectra. This is a coordinates mesh</span>
	<span class="c1"># at the end slicing the arrays to get the X, Y coordinates, we don&#39;t need the mesh</span>
	<span class="n">meshx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">xcoo</span><span class="p">,</span> <span class="p">(</span><span class="n">mapsize</span><span class="p">,</span> <span class="n">mapsize</span><span class="p">,</span> <span class="n">numberofspectra</span><span class="p">),</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">)[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span>
	<span class="n">meshy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">ycoo</span><span class="p">,</span> <span class="p">(</span><span class="n">mapsize</span><span class="p">,</span> <span class="n">mapsize</span><span class="p">,</span> <span class="n">numberofspectra</span><span class="p">),</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">)[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span>
	<span class="n">tempx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">xcoo</span><span class="p">,</span> <span class="p">(</span><span class="n">mapsize</span><span class="p">,</span> <span class="n">mapsize</span><span class="p">,</span> <span class="n">numberofspectra</span><span class="p">),</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span>
	<span class="n">tempy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">ycoo</span><span class="p">,</span> <span class="p">(</span><span class="n">mapsize</span><span class="p">,</span> <span class="n">mapsize</span><span class="p">,</span> <span class="n">numberofspectra</span><span class="p">),</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

	<span class="c1"># Constructing the xarray DataSet </span>
	<span class="c1"># stacking the forward and backward bias sweeps and using the scandir coordinate</span>
	<span class="c1"># also adding specific attributes</span>
	<span class="n">xrspec</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span>
		<span class="n">data_vars</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
			<span class="n">lia</span> <span class="o">=</span> <span class="p">([</span><span class="s1">&#39;bias&#39;</span><span class="p">,</span> <span class="s1">&#39;specpos_x&#39;</span><span class="p">,</span> <span class="s1">&#39;specpos_y&#39;</span><span class="p">,</span> <span class="s1">&#39;repetitions&#39;</span><span class="p">,</span> <span class="s1">&#39;biasscandir&#39;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">liafw</span><span class="p">,</span> <span class="n">liabw</span><span class="p">),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">12</span><span class="p">),</span>
			<span class="n">current</span> <span class="o">=</span> <span class="p">([</span><span class="s1">&#39;bias&#39;</span><span class="p">,</span> <span class="s1">&#39;specpos_x&#39;</span><span class="p">,</span> <span class="s1">&#39;specpos_y&#39;</span><span class="p">,</span> <span class="s1">&#39;repetitions&#39;</span><span class="p">,</span> <span class="s1">&#39;biasscandir&#39;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">currentfw</span><span class="p">,</span> <span class="n">currentbw</span><span class="p">),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">12</span><span class="p">),</span>
			<span class="n">x</span> <span class="o">=</span> <span class="p">([</span><span class="s1">&#39;specpos_x&#39;</span><span class="p">,</span> <span class="s1">&#39;specpos_y&#39;</span><span class="p">],</span> <span class="n">meshx</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">9</span><span class="p">),</span>
			<span class="n">y</span> <span class="o">=</span> <span class="p">([</span><span class="s1">&#39;specpos_x&#39;</span><span class="p">,</span> <span class="s1">&#39;specpos_y&#39;</span><span class="p">],</span> <span class="n">meshy</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">9</span><span class="p">)</span>
			<span class="p">),</span>
		<span class="n">coords</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
			<span class="n">bias</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;LIA_Current_x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
			<span class="n">specpos_x</span> <span class="o">=</span> <span class="n">tempx</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">9</span><span class="p">,</span>
			<span class="n">specpos_y</span> <span class="o">=</span> <span class="n">tempy</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">9</span><span class="p">,</span>
			<span class="n">repetitions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">stmdata_object</span><span class="o">.</span><span class="n">repetitions</span><span class="p">)),</span>
			<span class="n">biasscandir</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="s1">&#39;right&#39;</span><span class="p">],</span> <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;U&#39;</span><span class="p">)</span>
			<span class="p">),</span>
		<span class="n">attrs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">filename</span> <span class="o">=</span> <span class="n">_get_filename</span><span class="p">(</span><span class="n">stmdata_object</span><span class="o">.</span><span class="n">filename</span><span class="p">))</span>
	<span class="p">)</span>

	<span class="n">xrspec</span><span class="p">[</span><span class="s1">&#39;lia&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;pA&#39;</span>
	<span class="n">xrspec</span><span class="p">[</span><span class="s1">&#39;lia&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;picoampere&#39;</span>
	<span class="n">xrspec</span><span class="p">[</span><span class="s1">&#39;current&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;pA&#39;</span>
	<span class="n">xrspec</span><span class="p">[</span><span class="s1">&#39;current&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;picoampere&#39;</span>
	<span class="n">xrspec</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nm&#39;</span>
	<span class="n">xrspec</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nanometer&#39;</span>
	<span class="n">xrspec</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nm&#39;</span>
	<span class="n">xrspec</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nanometer&#39;</span>
	<span class="n">xrspec</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;bias&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;V&#39;</span>
	<span class="n">xrspec</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;specpos_x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nm&#39;</span>
	<span class="n">xrspec</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;specpos_y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nm&#39;</span>
	<span class="n">xrspec</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;specpos_x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nanometer&#39;</span>
	<span class="n">xrspec</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;specpos_y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nanometer&#39;</span>

	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span> <span class="o">=</span> <span class="n">xrspec</span>
	<span class="k">return</span> <span class="n">stmdata_object</span>


<span class="k">def</span> <span class="nf">_xr_line_iv</span><span class="p">(</span><span class="n">stmdata_object</span><span class="p">):</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Create a DataSet containing the Lock-In (LIA) and Current spectroscopy data</span>
<span class="sd">	Use the absolute values of the tip positions as coordinates</span>

<span class="sd">	In spym the spectroscopy data is loaded into an array,</span>
<span class="sd">	which has axis=0 the number of datapoints in the spectra</span>
<span class="sd">	and axis=1 the number of spectra in total.</span>

<span class="sd">	When rearranging, the number of repetitions within each tip position is assumed to be 1</span>
<span class="sd">	and alternate scan direction is assumed to be turned on.</span>
<span class="sd">	These options can be changed by the parameters, `repetitions` and `alternate`</span>
<span class="sd">	&quot;&quot;&quot;</span>

	<span class="c1"># extract the numpy array containing the LIA data from the spym object</span>
	<span class="n">specarray</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">LIA_Current</span><span class="o">.</span><span class="n">data</span>
	<span class="c1"># extract the numpy array containing the Current data from the spym object</span>
	<span class="n">currentarray</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">data</span>

	<span class="c1"># total number of spectra in one postion of the tip</span>
	<span class="n">numberofspectra</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">stmdata_object</span><span class="o">.</span><span class="n">alternate</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">stmdata_object</span><span class="o">.</span><span class="n">repetitions</span><span class="p">)</span>
	<span class="c1"># size of the line, the number of the different physical positions of the tip</span>
	<span class="n">linesize</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">specarray</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">numberofspectra</span><span class="p">)</span>

	<span class="c1"># reshape LIA data</span>
	<span class="c1"># Every other spectrum is a forward and backward scan in bias sweep. Separate the forward and backward scans into differing arrays by slicing.</span>
	<span class="c1"># These are all the forward and backward bias sweep spectra, arranged along axis=1, with axis=2 being the repetitions</span>
	<span class="n">templia</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">specarray</span><span class="p">,</span> <span class="p">(</span><span class="n">specarray</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">numberofspectra</span><span class="p">),</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">)</span>
	<span class="n">liafw</span> <span class="o">=</span> <span class="n">templia</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>
	<span class="n">liabw</span> <span class="o">=</span> <span class="n">templia</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>

	<span class="c1"># reshape Current data</span>
	<span class="n">tempcurr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">currentarray</span><span class="p">,</span> <span class="p">(</span><span class="n">currentarray</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">numberofspectra</span><span class="p">),</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">)</span>
	<span class="n">currentfw</span> <span class="o">=</span> <span class="n">tempcurr</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>
	<span class="n">currentbw</span> <span class="o">=</span> <span class="n">tempcurr</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>

<span class="w">	</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Coordinates of the spectroscopy map</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="c1"># &#39;RHK_SpecDrift_Xcoord&#39; are the coordinates of the spectra.</span>
	<span class="c1"># This contains the coordinates in the order that the spectra are in. </span>
	<span class="n">xcoo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">LIA_Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_SpecDrift_Xcoord&#39;</span><span class="p">])</span>
	<span class="n">ycoo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">LIA_Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_SpecDrift_Ycoord&#39;</span><span class="p">])</span>
	<span class="c1"># reshaping the coordinates similarly to the spectra. Need only every nth coordinate, where n is then number of spectra in a tip position</span>
	<span class="n">tempx</span> <span class="o">=</span> <span class="n">xcoo</span><span class="p">[</span><span class="mi">0</span><span class="p">::</span><span class="n">numberofspectra</span><span class="p">]</span>
	<span class="n">tempy</span> <span class="o">=</span> <span class="n">ycoo</span><span class="p">[</span><span class="mi">0</span><span class="p">::</span><span class="n">numberofspectra</span><span class="p">]</span>
	<span class="n">linelength</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">tempx</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">tempx</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">tempy</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">tempy</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
	<span class="c1"># distance coordinates along the line in [nm]</span>
	<span class="n">linecoord</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">linelength</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">tempx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">9</span>

<span class="w">	</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Constructing the xarray Dataset </span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="c1"># stacking the forward and backward bias sweeps and using the scandir coordinate</span>
	<span class="c1"># also adding specific attributes</span>
	<span class="n">xrspec</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span>
		<span class="n">data_vars</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
			<span class="n">lia</span> <span class="o">=</span> <span class="p">([</span><span class="s1">&#39;bias&#39;</span><span class="p">,</span> <span class="s1">&#39;dist&#39;</span><span class="p">,</span> <span class="s1">&#39;repetitions&#39;</span><span class="p">,</span> <span class="s1">&#39;biasscandir&#39;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">liafw</span><span class="p">,</span> <span class="n">liabw</span><span class="p">),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">12</span><span class="p">),</span>
			<span class="n">current</span> <span class="o">=</span> <span class="p">([</span><span class="s1">&#39;bias&#39;</span><span class="p">,</span> <span class="s1">&#39;dist&#39;</span><span class="p">,</span> <span class="s1">&#39;repetitions&#39;</span><span class="p">,</span> <span class="s1">&#39;biasscandir&#39;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">currentfw</span><span class="p">,</span> <span class="n">currentbw</span><span class="p">),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">12</span><span class="p">),</span>
			<span class="n">x</span> <span class="o">=</span> <span class="p">([</span><span class="s1">&#39;dist&#39;</span><span class="p">],</span> <span class="n">tempx</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">9</span><span class="p">),</span>
			<span class="n">y</span> <span class="o">=</span> <span class="p">([</span><span class="s1">&#39;dist&#39;</span><span class="p">],</span> <span class="n">tempy</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">9</span><span class="p">)</span>
			<span class="p">),</span>
		<span class="n">coords</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
			<span class="n">bias</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;LIA_Current_x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
			<span class="n">dist</span> <span class="o">=</span> <span class="n">linecoord</span><span class="p">,</span>
			<span class="n">repetitions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">stmdata_object</span><span class="o">.</span><span class="n">repetitions</span><span class="p">)),</span>
			<span class="n">biasscandir</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="s1">&#39;right&#39;</span><span class="p">],</span> <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;U&#39;</span><span class="p">)</span>
			<span class="p">),</span>
		<span class="n">attrs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">filename</span> <span class="o">=</span> <span class="n">_get_filename</span><span class="p">(</span><span class="n">stmdata_object</span><span class="o">.</span><span class="n">filename</span><span class="p">))</span>
	<span class="p">)</span>

	<span class="n">xrspec</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;dist&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nm&#39;</span>
	<span class="n">xrspec</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;dist&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nanometer&#39;</span>

	<span class="n">xrspec</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nm&#39;</span>
	<span class="n">xrspec</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nm&#39;</span>
	<span class="n">xrspec</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nanometer&#39;</span>
	<span class="n">xrspec</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nanometer&#39;</span>
	<span class="n">xrspec</span><span class="p">[</span><span class="s1">&#39;lia&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;pA&#39;</span>
	<span class="n">xrspec</span><span class="p">[</span><span class="s1">&#39;lia&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;picoampere&#39;</span>
	<span class="n">xrspec</span><span class="p">[</span><span class="s1">&#39;current&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;pA&#39;</span>
	<span class="n">xrspec</span><span class="p">[</span><span class="s1">&#39;current&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;picoampere&#39;</span>

	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span> <span class="o">=</span> <span class="n">xrspec</span>
	<span class="k">return</span> <span class="n">stmdata_object</span>


<span class="k">def</span> <span class="nf">_xr_spec_iv</span><span class="p">(</span><span class="n">stmdata_object</span><span class="p">):</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Create a DataSet containing the Lock-In (LIA) and Current spectroscopy data</span>
<span class="sd">	Use the absolute values of the tip positions are in the attributes</span>
<span class="sd">	&quot;&quot;&quot;</span>

	<span class="c1"># extract the numpy array containing the LIA data from the spym object</span>
	<span class="n">specarray</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">LIA_Current</span><span class="o">.</span><span class="n">data</span>
	<span class="c1"># extract the numpy array containing the Current data from the spym object</span>
	<span class="n">currentarray</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">data</span>

	<span class="c1"># reshape LIA data</span>
	<span class="c1"># Every other spectrum is a forward and backward scan in bias sweep. Separate the forward and backward scans into differing arrays by slicing.</span>
	<span class="n">liafw</span> <span class="o">=</span> <span class="n">specarray</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>
	<span class="n">liabw</span> <span class="o">=</span> <span class="n">specarray</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>

	<span class="c1"># reshape Current data</span>
	<span class="n">currentfw</span> <span class="o">=</span> <span class="n">currentarray</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>
	<span class="n">currentbw</span> <span class="o">=</span> <span class="n">currentarray</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>

<span class="w">	</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Coordinates of the spectroscopy map</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="c1"># &#39;RHK_SpecDrift_Xcoord&#39; are the coordinates of the spectra.</span>
	<span class="c1"># This contains the coordinates in the order that the spectra are in. </span>
	<span class="c1"># Here we only need the first x and y components</span>
	<span class="n">xcoo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">LIA_Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_SpecDrift_Xcoord&#39;</span><span class="p">])</span>
	<span class="n">ycoo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">LIA_Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_SpecDrift_Ycoord&#39;</span><span class="p">])</span>
	<span class="c1"># reshaping the coordinates similarly to the spectra. Need only every second coordinate</span>
	<span class="n">tempx</span> <span class="o">=</span> <span class="n">xcoo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
	<span class="n">tempy</span> <span class="o">=</span> <span class="n">ycoo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="w">	</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Constructing the xarray Dataset </span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="c1"># stacking the forward and backward bias sweeps and using the scandir coordinate</span>
	<span class="c1"># also adding specific attributes</span>
	<span class="n">xrspec</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span>
		<span class="n">data_vars</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
			<span class="n">lia</span> <span class="o">=</span> <span class="p">([</span><span class="s1">&#39;bias&#39;</span><span class="p">,</span> <span class="s1">&#39;repetitions&#39;</span><span class="p">,</span> <span class="s1">&#39;biasscandir&#39;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">liafw</span><span class="p">,</span> <span class="n">liabw</span><span class="p">),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">12</span><span class="p">),</span>
			<span class="n">current</span> <span class="o">=</span> <span class="p">([</span><span class="s1">&#39;bias&#39;</span><span class="p">,</span> <span class="s1">&#39;repetitions&#39;</span><span class="p">,</span> <span class="s1">&#39;biasscandir&#39;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">currentfw</span><span class="p">,</span> <span class="n">currentbw</span><span class="p">),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">12</span><span class="p">)</span>
			<span class="p">),</span>
		<span class="n">coords</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
			<span class="n">bias</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;LIA_Current_x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
			<span class="n">repetitions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">stmdata_object</span><span class="o">.</span><span class="n">repetitions</span><span class="p">)),</span>
			<span class="n">biasscandir</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="s1">&#39;right&#39;</span><span class="p">],</span> <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;U&#39;</span><span class="p">)</span>
			<span class="p">),</span>
		<span class="n">attrs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">filename</span> <span class="o">=</span> <span class="n">_get_filename</span><span class="p">(</span><span class="n">stmdata_object</span><span class="o">.</span><span class="n">filename</span><span class="p">))</span>
	<span class="p">)</span>

	<span class="n">xrspec</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;speccoord_x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tempx</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">9</span>
	<span class="n">xrspec</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;speccoord_y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tempy</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">9</span>
	<span class="n">xrspec</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;speccoord_x units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nm&#39;</span>
	<span class="n">xrspec</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;speccoord_y units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nm&#39;</span>

	<span class="n">xrspec</span><span class="p">[</span><span class="s1">&#39;lia&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;pA&#39;</span>
	<span class="n">xrspec</span><span class="p">[</span><span class="s1">&#39;lia&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;picoampere&#39;</span>
	<span class="n">xrspec</span><span class="p">[</span><span class="s1">&#39;current&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;pA&#39;</span>
	<span class="n">xrspec</span><span class="p">[</span><span class="s1">&#39;current&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;picoampere&#39;</span>

	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span> <span class="o">=</span> <span class="n">xrspec</span>
	<span class="k">return</span> <span class="n">stmdata_object</span>


<span class="k">def</span> <span class="nf">_xr_map_iz</span><span class="p">(</span><span class="n">stmdata_object</span><span class="p">):</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	TODO need to change spectrum rearranging for the case where alternate is False</span>

<span class="sd">	Create a DataSet containing the Lock-In (LIA) and Current spectroscopy data</span>
<span class="sd">	Use the absolute values of the tip positions as coordinates</span>

<span class="sd">	In spym the spectroscopy data is loaded into an array,</span>
<span class="sd">	which has axis=0 the number of datapoints in the spectra</span>
<span class="sd">	and axis=1 the number of spectra in total.</span>

<span class="sd">	When rearranging, the number of repetitions within each tip position is assumed to be 1</span>
<span class="sd">	and alternate scan direction is assumed to be turned on.</span>
<span class="sd">	These options can be changed by the parameters, `repetitions` and `alternate`</span>
<span class="sd">	&quot;&quot;&quot;</span>

	<span class="c1"># extract the numpy array containing the Current data from the spym object</span>
	<span class="n">currentarray</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">data</span>

	<span class="c1"># total number of spectra in one postion of the tip</span>
	<span class="n">numberofspectra</span> <span class="o">=</span> <span class="p">(</span><span class="n">stmdata_object</span><span class="o">.</span><span class="n">alternate</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">stmdata_object</span><span class="o">.</span><span class="n">repetitions</span>
	<span class="c1"># size of the map in mapsize x mapsize</span>
	<span class="n">mapsize</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">currentarray</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">numberofspectra</span><span class="p">))</span>

	<span class="c1"># reshape Current data</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">currentarray</span><span class="p">,</span> <span class="p">(</span><span class="n">currentarray</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">numberofspectra</span><span class="p">),</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">)</span>
	<span class="c1"># Every other spectrum is a forward and backward scan in bias sweep. Separate the forward and backward scans into differing arrays by slicing.</span>
	<span class="c1"># These are all the forward and backward bias sweep spectra, arranged along axis=1, with axis=2 being the repetitions</span>
	<span class="n">current_fw</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>
	<span class="n">current_bw</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>
	<span class="c1"># reshape the forward and backward parts into a map</span>
	<span class="n">currentmap_fw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">current_fw</span><span class="p">,</span> <span class="p">(</span><span class="n">current_fw</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mapsize</span><span class="p">,</span> <span class="n">mapsize</span><span class="p">,</span> <span class="n">current_fw</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">)</span>
	<span class="n">currentmap_bw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">current_bw</span><span class="p">,</span> <span class="p">(</span><span class="n">current_bw</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mapsize</span><span class="p">,</span> <span class="n">mapsize</span><span class="p">,</span> <span class="n">current_bw</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">)</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	The last axis (in this case with length of 1) contains the repeated scans in one particular pixel.</span>
<span class="sd">	If the `repetitions` variable is set to greater than 1, this will contains the repeated spectra within an `X, Y` pixel.</span>
<span class="sd">	The array needs to be flipped along axis = 1 (the &quot;x&quot; axis in the topography image) to fit with the data read by the ASCII method</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="n">currentfw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">currentmap_fw</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
	<span class="n">currentbw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">currentmap_bw</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>	

<span class="w">	</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Coordinates of the spectroscopy map</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="c1"># &#39;RHK_SpecDrift_Xcoord&#39; are the coordinates of the spectra.</span>
	<span class="c1"># This contains the coordinates in the order that the spectra are in. </span>
	<span class="n">xcoo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_SpecDrift_Xcoord&#39;</span><span class="p">])</span>
	<span class="n">ycoo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_SpecDrift_Ycoord&#39;</span><span class="p">])</span>
	<span class="c1"># reshaping the coordinates similarly to the spectra. This is a coordinates mesh</span>
	<span class="c1"># at the end slicing the arrays to get the X, Y coordinates, we don&#39;t need the mesh</span>
	<span class="n">meshx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">xcoo</span><span class="p">,</span> <span class="p">(</span><span class="n">mapsize</span><span class="p">,</span> <span class="n">mapsize</span><span class="p">,</span> <span class="n">numberofspectra</span><span class="p">),</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">)[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span>
	<span class="n">meshy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">ycoo</span><span class="p">,</span> <span class="p">(</span><span class="n">mapsize</span><span class="p">,</span> <span class="n">mapsize</span><span class="p">,</span> <span class="n">numberofspectra</span><span class="p">),</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">)[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span>
	<span class="n">tempx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">xcoo</span><span class="p">,</span> <span class="p">(</span><span class="n">mapsize</span><span class="p">,</span> <span class="n">mapsize</span><span class="p">,</span> <span class="n">numberofspectra</span><span class="p">),</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span>
	<span class="n">tempy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">ycoo</span><span class="p">,</span> <span class="p">(</span><span class="n">mapsize</span><span class="p">,</span> <span class="n">mapsize</span><span class="p">,</span> <span class="n">numberofspectra</span><span class="p">),</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

<span class="w">	</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Constructing the xarray DataSet </span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="c1"># stacking the forward and backward bias sweeps and using the scandir coordinate</span>
	<span class="c1"># also adding specific attributes</span>
	<span class="n">xrspec</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span>
		<span class="n">data_vars</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
			<span class="n">current</span> <span class="o">=</span> <span class="p">([</span><span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="s1">&#39;specpos_x&#39;</span><span class="p">,</span> <span class="s1">&#39;specpos_y&#39;</span><span class="p">,</span> <span class="s1">&#39;repetitions&#39;</span><span class="p">,</span> <span class="s1">&#39;zscandir&#39;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">currentfw</span><span class="p">,</span> <span class="n">currentbw</span><span class="p">),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">12</span><span class="p">),</span>
			<span class="n">x</span> <span class="o">=</span> <span class="p">([</span><span class="s1">&#39;specpos_x&#39;</span><span class="p">,</span> <span class="s1">&#39;specpos_y&#39;</span><span class="p">],</span> <span class="n">meshx</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">9</span><span class="p">),</span>
			<span class="n">y</span> <span class="o">=</span> <span class="p">([</span><span class="s1">&#39;specpos_x&#39;</span><span class="p">,</span> <span class="s1">&#39;specpos_y&#39;</span><span class="p">],</span> <span class="n">meshy</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">9</span><span class="p">)</span>
			<span class="p">),</span>
		<span class="n">coords</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
			<span class="n">z</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;Current_x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">9</span><span class="p">,</span>
			<span class="n">specpos_x</span> <span class="o">=</span> <span class="n">tempx</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">9</span><span class="p">,</span>
			<span class="n">specpos_y</span> <span class="o">=</span> <span class="n">tempy</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">9</span><span class="p">,</span>
			<span class="n">repetitions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">stmdata_object</span><span class="o">.</span><span class="n">repetitions</span><span class="p">)),</span>
			<span class="n">zscandir</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="s1">&#39;up&#39;</span><span class="p">,</span> <span class="s1">&#39;down&#39;</span><span class="p">],</span> <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;U&#39;</span><span class="p">)</span>
			<span class="p">),</span>
		<span class="n">attrs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">filename</span> <span class="o">=</span> <span class="n">_get_filename</span><span class="p">(</span><span class="n">stmdata_object</span><span class="o">.</span><span class="n">filename</span><span class="p">))</span>
	<span class="p">)</span>

	<span class="n">xrspec</span><span class="p">[</span><span class="s1">&#39;current&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;pA&#39;</span>
	<span class="n">xrspec</span><span class="p">[</span><span class="s1">&#39;current&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;picoampere&#39;</span>
	<span class="n">xrspec</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nm&#39;</span>
	<span class="n">xrspec</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nanometer&#39;</span>
	<span class="n">xrspec</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nm&#39;</span>
	<span class="n">xrspec</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nanometer&#39;</span>
	<span class="n">xrspec</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nm&#39;</span>
	<span class="n">xrspec</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nanometer&#39;</span>
	<span class="n">xrspec</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;specpos_x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nm&#39;</span>
	<span class="n">xrspec</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;specpos_y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nm&#39;</span>
	<span class="n">xrspec</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;specpos_x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nanometer&#39;</span>
	<span class="n">xrspec</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;specpos_y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nanometer&#39;</span>

	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span> <span class="o">=</span> <span class="n">xrspec</span>
	<span class="k">return</span> <span class="n">stmdata_object</span>


<span class="k">def</span> <span class="nf">_xr_line_iz</span><span class="p">(</span><span class="n">stmdata_object</span><span class="p">):</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Create a DataSet containing the Lock-In (LIA) and Current spectroscopy data</span>
<span class="sd">	Use the absolute values of the tip positions as coordinates</span>

<span class="sd">	In spym the spectroscopy data is loaded into an array,</span>
<span class="sd">	which has axis=0 the number of datapoints in the spectra</span>
<span class="sd">	and axis=1 the number of spectra in total.</span>

<span class="sd">	When rearranging, the number of repetitions within each tip position is assumed to be 1</span>
<span class="sd">	and alternate scan direction is assumed to be turned on.</span>
<span class="sd">	These options can be changed by the parameters, `repetitions` and `alternate`</span>
<span class="sd">	&quot;&quot;&quot;</span>

	<span class="c1"># extract the numpy array containing the Current data from the spym object</span>
	<span class="n">currentarray</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">data</span>

	<span class="c1"># total number of spectra in one postion of the tip</span>
	<span class="n">numberofspectra</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">stmdata_object</span><span class="o">.</span><span class="n">alternate</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">stmdata_object</span><span class="o">.</span><span class="n">repetitions</span><span class="p">)</span>
	<span class="c1"># size of the line, the number of the different physical positions of the tip</span>
	<span class="n">linesize</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">currentarray</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">numberofspectra</span><span class="p">)</span>

	<span class="c1"># reshape Current data</span>
	<span class="n">tempcurr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">currentarray</span><span class="p">,</span> <span class="p">(</span><span class="n">currentarray</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">numberofspectra</span><span class="p">),</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">)</span>
	<span class="n">currentfw</span> <span class="o">=</span> <span class="n">tempcurr</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>
	<span class="n">currentbw</span> <span class="o">=</span> <span class="n">tempcurr</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>

<span class="w">	</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Coordinates of the spectroscopy map</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="c1"># &#39;RHK_SpecDrift_Xcoord&#39; are the coordinates of the spectra.</span>
	<span class="c1"># This contains the coordinates in the order that the spectra are in. </span>
	<span class="n">xcoo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_SpecDrift_Xcoord&#39;</span><span class="p">])</span>
	<span class="n">ycoo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_SpecDrift_Ycoord&#39;</span><span class="p">])</span>
	<span class="c1"># reshaping the coordinates similarly to the spectra. Need only every nth coordinate, where n is the number of spectra in a position</span>
	<span class="n">tempx</span> <span class="o">=</span> <span class="n">xcoo</span><span class="p">[</span><span class="mi">0</span><span class="p">::</span><span class="n">numberofspectra</span><span class="p">]</span>
	<span class="n">tempy</span> <span class="o">=</span> <span class="n">ycoo</span><span class="p">[</span><span class="mi">0</span><span class="p">::</span><span class="n">numberofspectra</span><span class="p">]</span>
	<span class="n">linelength</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">tempx</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">tempx</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">tempy</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">tempy</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
	<span class="c1"># distance coordinates along the line in [nm]</span>
	<span class="n">linecoord</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">linelength</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">tempx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">9</span>

<span class="w">	</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Constructing the xarray Dataset </span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="c1"># stacking the forward and backward bias sweeps and using the scandir coordinate</span>
	<span class="c1"># also adding specific attributes</span>
	<span class="n">xrspec</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span>
		<span class="n">data_vars</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
			<span class="n">current</span> <span class="o">=</span> <span class="p">([</span><span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="s1">&#39;dist&#39;</span><span class="p">,</span> <span class="s1">&#39;repetitions&#39;</span><span class="p">,</span> <span class="s1">&#39;zscandir&#39;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">currentfw</span><span class="p">,</span> <span class="n">currentbw</span><span class="p">),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">12</span><span class="p">),</span>
			<span class="n">x</span> <span class="o">=</span> <span class="p">([</span><span class="s1">&#39;dist&#39;</span><span class="p">],</span> <span class="n">tempx</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">9</span><span class="p">),</span>
			<span class="n">y</span> <span class="o">=</span> <span class="p">([</span><span class="s1">&#39;dist&#39;</span><span class="p">],</span> <span class="n">tempy</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">9</span><span class="p">)</span>
			<span class="p">),</span>
		<span class="n">coords</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
			<span class="n">z</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;Current_x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">9</span><span class="p">,</span>
			<span class="n">dist</span> <span class="o">=</span> <span class="n">linecoord</span><span class="p">,</span>
			<span class="n">repetitions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">stmdata_object</span><span class="o">.</span><span class="n">repetitions</span><span class="p">)),</span>
			<span class="n">zscandir</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="s1">&#39;up&#39;</span><span class="p">,</span> <span class="s1">&#39;down&#39;</span><span class="p">],</span> <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;U&#39;</span><span class="p">)</span>
			<span class="p">),</span>
		<span class="n">attrs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">filename</span> <span class="o">=</span> <span class="n">_get_filename</span><span class="p">(</span><span class="n">stmdata_object</span><span class="o">.</span><span class="n">filename</span><span class="p">))</span>
	<span class="p">)</span>

	<span class="n">xrspec</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;dist&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nm&#39;</span>
	<span class="n">xrspec</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;dist&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nanometer&#39;</span>
	<span class="n">xrspec</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nm&#39;</span>
	<span class="n">xrspec</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nanometer&#39;</span>

	<span class="n">xrspec</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nm&#39;</span>
	<span class="n">xrspec</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nm&#39;</span>
	<span class="n">xrspec</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nanometer&#39;</span>
	<span class="n">xrspec</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nanometer&#39;</span>
	<span class="n">xrspec</span><span class="p">[</span><span class="s1">&#39;current&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;pA&#39;</span>
	<span class="n">xrspec</span><span class="p">[</span><span class="s1">&#39;current&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;picoampere&#39;</span>

	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span> <span class="o">=</span> <span class="n">xrspec</span>
	<span class="k">return</span> <span class="n">stmdata_object</span>


<span class="k">def</span> <span class="nf">_xr_spec_iz</span><span class="p">(</span><span class="n">stmdata_object</span><span class="p">):</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Create a DataSet containing the Lock-In (LIA) and Current spectroscopy data</span>
<span class="sd">	Use the absolute values of the tip positions are in the attributes</span>
<span class="sd">	&quot;&quot;&quot;</span>

	<span class="c1"># extract the numpy array containing the Current data from the spym object</span>
	<span class="n">currentarray</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">data</span>

	<span class="c1"># reshape Current data</span>
	<span class="n">currentfw</span> <span class="o">=</span> <span class="n">currentarray</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>
	<span class="n">currentbw</span> <span class="o">=</span> <span class="n">currentarray</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>

<span class="w">	</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Coordinates of the spectroscopy map</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="c1"># &#39;RHK_SpecDrift_Xcoord&#39; are the coordinates of the spectra.</span>
	<span class="c1"># This contains the coordinates in the order that the spectra are in. </span>
	<span class="c1"># Here we only need the first x and y components</span>
	<span class="n">xcoo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_SpecDrift_Xcoord&#39;</span><span class="p">])</span>
	<span class="n">ycoo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_SpecDrift_Ycoord&#39;</span><span class="p">])</span>
	<span class="c1"># reshaping the coordinates similarly to the spectra. Need only every second coordinate</span>
	<span class="n">tempx</span> <span class="o">=</span> <span class="n">xcoo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
	<span class="n">tempy</span> <span class="o">=</span> <span class="n">ycoo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="w">	</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Constructing the xarray Dataset </span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="c1"># stacking the forward and backward bias sweeps and using the scandir coordinate</span>
	<span class="c1"># also adding specific attributes</span>
	<span class="n">xrspec</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span>
		<span class="n">data_vars</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
			<span class="n">current</span> <span class="o">=</span> <span class="p">([</span><span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="s1">&#39;repetitions&#39;</span><span class="p">,</span> <span class="s1">&#39;zscandir&#39;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">currentfw</span><span class="p">,</span> <span class="n">currentbw</span><span class="p">),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">12</span><span class="p">)</span>
			<span class="p">),</span>
		<span class="n">coords</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
			<span class="n">z</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;Current_x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">9</span><span class="p">,</span>
			<span class="n">repetitions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">stmdata_object</span><span class="o">.</span><span class="n">repetitions</span><span class="p">)),</span>
			<span class="n">zscandir</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="s1">&#39;up&#39;</span><span class="p">,</span> <span class="s1">&#39;down&#39;</span><span class="p">],</span> <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;U&#39;</span><span class="p">)</span>
			<span class="p">),</span>
		<span class="n">attrs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">filename</span> <span class="o">=</span> <span class="n">_get_filename</span><span class="p">(</span><span class="n">stmdata_object</span><span class="o">.</span><span class="n">filename</span><span class="p">))</span>
	<span class="p">)</span>

	<span class="n">xrspec</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;speccoord_x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tempx</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">9</span>
	<span class="n">xrspec</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;speccoord_y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tempy</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">9</span>
	<span class="n">xrspec</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;speccoord_x units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nm&#39;</span>
	<span class="n">xrspec</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;speccoord_y units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nm&#39;</span>
	<span class="n">xrspec</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nm&#39;</span>
	<span class="n">xrspec</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nanometer&#39;</span>
	<span class="n">xrspec</span><span class="p">[</span><span class="s1">&#39;current&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;pA&#39;</span>
	<span class="n">xrspec</span><span class="p">[</span><span class="s1">&#39;current&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;picoampere&#39;</span>

	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span> <span class="o">=</span> <span class="n">xrspec</span>
	<span class="k">return</span> <span class="n">stmdata_object</span>


<span class="k">def</span> <span class="nf">_xr_image</span><span class="p">(</span><span class="n">stmdata_object</span><span class="p">):</span>
	<span class="c1"># topography</span>
	<span class="n">topofw</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Topography_Forward</span>
	<span class="n">topobw</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Topography_Backward</span>
	
	<span class="c1"># Load image data</span>
	<span class="c1"># use spym to align (flatten the data) and planefit</span>
	<span class="n">topofw</span><span class="p">,</span> <span class="n">bg</span> <span class="o">=</span> <span class="n">align</span><span class="p">(</span><span class="n">topofw</span><span class="p">,</span> <span class="n">baseline</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">)</span>
	<span class="n">topobw</span><span class="p">,</span> <span class="n">bg</span> <span class="o">=</span> <span class="n">align</span><span class="p">(</span><span class="n">topobw</span><span class="p">,</span> <span class="n">baseline</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">)</span>
	<span class="n">topofw</span><span class="p">,</span> <span class="n">bg</span> <span class="o">=</span> <span class="n">plane</span><span class="p">(</span><span class="n">topofw</span><span class="p">)</span>
	<span class="n">topobw</span><span class="p">,</span> <span class="n">bg</span> <span class="o">=</span> <span class="n">plane</span><span class="p">(</span><span class="n">topobw</span><span class="p">)</span>
	<span class="c1"># current</span>
	<span class="n">currfw</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current_Forward</span>
	<span class="n">currbw</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current_Backward</span>
	<span class="c1"># lia</span>
	<span class="n">liafw</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">LIA_Current_Forward</span>
	<span class="n">liabw</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">LIA_Current_Backward</span>

	<span class="c1"># coordinates</span>
	<span class="c1"># absolute values should be found by adding the X Y offsets</span>
	<span class="n">xoff</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Topography_Forward</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_Xoffset&#39;</span><span class="p">]</span>
	<span class="n">yoff</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Topography_Forward</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_Yoffset&#39;</span><span class="p">]</span>

	<span class="c1"># these are the relative coordinates (from 0 to size of the image)</span>
	<span class="n">xx</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Topography_Forward_x</span><span class="o">.</span><span class="n">data</span>
	<span class="n">yy</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Topography_Forward_y</span><span class="o">.</span><span class="n">data</span>

	<span class="c1"># calculate the relative coordinates, including rotation</span>
	<span class="c1"># the offset refers to the corner of the image, so we need to account for that</span>
	<span class="n">xlength</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">xx</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">xx</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
	<span class="n">ylength</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">yy</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">yy</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

	<span class="n">xoff</span> <span class="o">-=</span> <span class="n">xlength</span><span class="o">/</span><span class="mi">2</span>
	<span class="n">yoff</span> <span class="o">-=</span> <span class="n">ylength</span><span class="o">/</span><span class="mi">2</span>

	<span class="c1"># create xarray Dataset of the image data</span>
	<span class="n">xrimage</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span>
		<span class="n">data_vars</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
			<span class="n">topography</span> <span class="o">=</span> <span class="p">([</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;scandir&#39;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">topofw</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">topobw</span><span class="o">.</span><span class="n">data</span><span class="p">),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">9</span><span class="p">),</span>
			<span class="n">current</span> <span class="o">=</span> <span class="p">([</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;scandir&#39;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">currfw</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">currbw</span><span class="o">.</span><span class="n">data</span><span class="p">),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">12</span><span class="p">),</span>
			<span class="n">lia</span> <span class="o">=</span> <span class="p">([</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;scandir&#39;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">liafw</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">liabw</span><span class="o">.</span><span class="n">data</span><span class="p">),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">12</span><span class="p">)</span>
			<span class="p">),</span>
		<span class="n">coords</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
			<span class="n">x</span> <span class="o">=</span> <span class="n">xx</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">9</span><span class="p">,</span>
			<span class="n">y</span> <span class="o">=</span> <span class="n">yy</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">9</span><span class="p">,</span>
			<span class="n">scandir</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="s1">&#39;forward&#39;</span><span class="p">,</span> <span class="s1">&#39;backward&#39;</span><span class="p">])</span>
			<span class="p">),</span>
		<span class="n">attrs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
			<span class="n">filename</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span>
			<span class="n">xoffset</span> <span class="o">=</span> <span class="n">xoff</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">9</span><span class="p">,</span>
			<span class="n">yoffset</span> <span class="o">=</span> <span class="n">yoff</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">9</span><span class="p">,</span>
			<span class="n">xoffset_units</span> <span class="o">=</span> <span class="s1">&#39;nm&#39;</span><span class="p">,</span>
			<span class="n">yoffset_units</span> <span class="o">=</span> <span class="s1">&#39;nm&#39;</span>
			<span class="p">)</span>
		<span class="p">)</span>
	
	<span class="n">xrimage</span><span class="p">[</span><span class="s1">&#39;topography&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nm&#39;</span>
	<span class="n">xrimage</span><span class="p">[</span><span class="s1">&#39;topography&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nanometer&#39;</span>
	<span class="n">xrimage</span><span class="p">[</span><span class="s1">&#39;lia&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;pA&#39;</span>
	<span class="n">xrimage</span><span class="p">[</span><span class="s1">&#39;lia&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;picoampere&#39;</span>
	<span class="n">xrimage</span><span class="p">[</span><span class="s1">&#39;current&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;pA&#39;</span>
	<span class="n">xrimage</span><span class="p">[</span><span class="s1">&#39;current&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;picoampere&#39;</span>
	<span class="n">xrimage</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nm&#39;</span>
	<span class="n">xrimage</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nm&#39;</span>
	<span class="n">xrimage</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nanometer&#39;</span>
	<span class="n">xrimage</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nanometer&#39;</span>

	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">xrimage</span>
	<span class="k">return</span> <span class="n">stmdata_object</span>


<span class="k">def</span> <span class="nf">_add_map_metadata</span><span class="p">(</span><span class="n">stmdata_object</span><span class="p">):</span>
	<span class="k">if</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectype</span> <span class="o">==</span> <span class="s1">&#39;iv&#39;</span><span class="p">:</span>
		<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;lia&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;bias&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;bias&#39;</span><span class="p">]</span>
		<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;lia&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;bias units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;V&#39;</span>
		<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;lia&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;setpoint&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_Current&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">12</span>
		<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;lia&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;setpoint units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;pA&#39;</span>
		<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;lia&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;time_per_point&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;time_per_point&#39;</span><span class="p">]</span>

	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;current&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;bias&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;bias&#39;</span><span class="p">]</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;current&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;bias units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;V&#39;</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;current&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;setpoint&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_Current&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">12</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;current&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;setpoint units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;pA&#39;</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;current&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;time_per_point&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;time_per_point&#39;</span><span class="p">]</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;bias&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;bias&#39;</span><span class="p">]</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;bias units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;V&#39;</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;setpoint&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_Current&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">12</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;setpoint units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;pA&#39;</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;measurement date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_Date&#39;</span><span class="p">]</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;measurement time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_Time&#39;</span><span class="p">]</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;scan angle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Topography_Forward</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_Angle&#39;</span><span class="p">]</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;LI amplitude&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_CH1Drive_Amplitude&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">3</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;LI amplitude unit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;mV&#39;</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;LI frequency&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_CH1Drive_Frequency&#39;</span><span class="p">]</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;LI frequency unit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Hz&#39;</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;LI phase&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_Lockin0_PhaseOffset&#39;</span><span class="p">]</span>

	<span class="c1"># store the data and spectrum type in the attributes</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;datatype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">datatype</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;spectype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectype</span>

	<span class="k">return</span> <span class="n">stmdata_object</span>


<span class="k">def</span> <span class="nf">_add_line_metadata</span><span class="p">(</span><span class="n">stmdata_object</span><span class="p">):</span>
	<span class="k">if</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectype</span> <span class="o">==</span> <span class="s1">&#39;iv&#39;</span><span class="p">:</span>
		<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;lia&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;bias&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;bias&#39;</span><span class="p">]</span>
		<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;lia&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;bias units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;V&#39;</span>
		<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;lia&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;setpoint&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_Current&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">12</span>
		<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;lia&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;setpoint units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;pA&#39;</span>
		<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;lia&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;time_per_point&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;time_per_point&#39;</span><span class="p">]</span>

	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;current&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;bias&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;bias&#39;</span><span class="p">]</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;current&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;bias units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;V&#39;</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;current&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;setpoint&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_Current&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">12</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;current&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;setpoint units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;pA&#39;</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;current&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;time_per_point&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;time_per_point&#39;</span><span class="p">]</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;bias&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;bias&#39;</span><span class="p">]</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;bias units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;V&#39;</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;setpoint&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_Current&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">12</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;setpoint units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;pA&#39;</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;measurement date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_Date&#39;</span><span class="p">]</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;measurement time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_Time&#39;</span><span class="p">]</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;scan angle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Topography_Forward</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_Angle&#39;</span><span class="p">]</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;LI amplitude&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_CH1Drive_Amplitude&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">3</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;LI amplitude unit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;mV&#39;</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;LI frequency&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_CH1Drive_Frequency&#39;</span><span class="p">]</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;LI frequency unit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Hz&#39;</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;LI phase&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_Lockin0_PhaseOffset&#39;</span><span class="p">]</span>

	<span class="c1"># store the data and spectrum type in the attributes</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;datatype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">datatype</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;spectype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectype</span>

	<span class="k">return</span> <span class="n">stmdata_object</span>


<span class="k">def</span> <span class="nf">_add_spec_metadata</span><span class="p">(</span><span class="n">stmdata_object</span><span class="p">):</span>
	<span class="k">if</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectype</span> <span class="o">==</span> <span class="s1">&#39;iv&#39;</span><span class="p">:</span>
		<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;lia&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;bias&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;bias&#39;</span><span class="p">]</span>
		<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;lia&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;bias units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;V&#39;</span>
		<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;lia&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;setpoint&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_Current&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">12</span>
		<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;lia&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;setpoint units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;pA&#39;</span>
		<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;lia&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;time_per_point&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;time_per_point&#39;</span><span class="p">]</span>
		<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;bias&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;V&#39;</span>
		<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;bias&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;volt&#39;</span>
	
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;current&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;bias&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;bias&#39;</span><span class="p">]</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;current&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;bias units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;V&#39;</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;current&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;setpoint&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_Current&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">12</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;current&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;setpoint units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;pA&#39;</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;current&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;time_per_point&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;time_per_point&#39;</span><span class="p">]</span>

	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;bias&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;bias&#39;</span><span class="p">]</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;bias units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;V&#39;</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;setpoint&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_Current&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">12</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;setpoint units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;pA&#39;</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;measurement date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_Date&#39;</span><span class="p">]</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;measurement time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_Time&#39;</span><span class="p">]</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;LI amplitude&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_CH1Drive_Amplitude&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">3</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;LI amplitude unit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;mV&#39;</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;LI frequency&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_CH1Drive_Frequency&#39;</span><span class="p">]</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;LI frequency unit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Hz&#39;</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;LI phase&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_Lockin0_PhaseOffset&#39;</span><span class="p">]</span>
	
	<span class="c1"># store the data and spectrum type in the attributes</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;datatype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">datatype</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;spectype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectype</span>
	
	<span class="k">return</span> <span class="n">stmdata_object</span>


<span class="k">def</span> <span class="nf">_add_image_metadata</span><span class="p">(</span><span class="n">stmdata_object</span><span class="p">):</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;bias&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Topography_Forward</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_Bias&#39;</span><span class="p">]</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;bias units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;V&#39;</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;setpoint&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Topography_Forward</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_Current&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">12</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;setpoint units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;pA&#39;</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;measurement date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Topography_Forward</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_Date&#39;</span><span class="p">]</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;measurement time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Topography_Forward</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_Time&#39;</span><span class="p">]</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;scan angle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Topography_Forward</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_Angle&#39;</span><span class="p">]</span>
	
	<span class="c1"># store the data and spectrum type in the attributes</span>
	<span class="c1"># in the case for a map, the datatype value will not be &#39;image&#39;, but &#39;map&#39;</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;datatype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">datatype</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;spectype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectype</span>

	<span class="k">return</span> <span class="n">stmdata_object</span>


<div class="viewcode-block" id="load_rhksm4"><a class="viewcode-back" href="../../rhkpy.html#rhkpy.rhkpy_loader.load_rhksm4">[docs]</a><span class="k">def</span> <span class="nf">load_rhksm4</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;Load the data from the .sm4 file using the old loader from spym&quot;&quot;&quot;</span>
	<span class="k">return</span> <span class="n">rhksm4</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span></div>

<div class="viewcode-block" id="load_spym"><a class="viewcode-back" href="../../rhkpy.html#rhkpy.rhkpy_loader.load_spym">[docs]</a><span class="k">def</span> <span class="nf">load_spym</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;Load the data from the .sm4 file using spym&quot;&quot;&quot;</span>
	<span class="k">return</span> <span class="n">load</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Peter Nemes-Incze.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>