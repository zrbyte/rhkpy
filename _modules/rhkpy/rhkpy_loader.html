<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>rhkpy.rhkpy_loader &mdash; rhkpy 2023.08.10 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=0f4f00c4"></script>
        <script src="../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            rhkpy
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../intro.html#installation">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../intro.html#id1">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rhkpy.html">rhkpy package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">rhkpy</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">rhkpy</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">rhkpy.rhkpy_loader</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for rhkpy.rhkpy_loader</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">pl</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
<span class="kn">import</span> <span class="nn">re</span><span class="o">,</span> <span class="nn">copy</span>
<span class="c1"># import load from spym</span>
<span class="kn">from</span> <span class="nn">spym.io</span> <span class="kn">import</span> <span class="n">load</span>
<span class="c1">## Using the old loader</span>
<span class="kn">from</span> <span class="nn">spym.io</span> <span class="kn">import</span> <span class="n">rhksm4</span>
<span class="c1">## flatten and plane fitting</span>
<span class="kn">from</span> <span class="nn">spym.process.level</span> <span class="kn">import</span> <span class="n">align</span>
<span class="kn">from</span> <span class="nn">spym.process.level</span> <span class="kn">import</span> <span class="n">plane</span>

<span class="c1"># for fancy plotting</span>
<span class="kn">import</span> <span class="nn">hvplot.xarray</span>
<span class="kn">import</span> <span class="nn">holoviews</span> <span class="k">as</span> <span class="nn">hv</span>
<span class="kn">import</span> <span class="nn">panel</span> <span class="k">as</span> <span class="nn">pn</span>

<span class="kn">from</span> <span class="nn">.rhkpy_process</span> <span class="kn">import</span> <span class="o">*</span>

<div class="viewcode-block" id="rhkdata">
<a class="viewcode-back" href="../../rhkpy.html#rhkpy.rhkpy_loader.rhkdata">[docs]</a>
<span class="k">class</span> <span class="nc">rhkdata</span><span class="p">:</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	A container for the xarray based structure of the RHK data. Loads the RHK &quot;sm4&quot; file from the path at: ``filename``.</span>

<span class="sd">	:param filename: path and filename of the &quot;sm4&quot; file to be loaded</span>
<span class="sd">	:type filename: str</span>
<span class="sd">	:param repetitions: The number of repeated aquisitions of spectra in tip position, defaults to 0</span>
<span class="sd">	:type repetitions: int, optional</span>
<span class="sd">	:param alternate: `True` if the bias is swept forward and backward, `False` if not, defaults to True</span>
<span class="sd">	:type alternate: bool, optional</span>
<span class="sd">	:param loadraw: Set to `True` if you want the raw topography data, defaults to False</span>
<span class="sd">	:type loadraw: bool, optional</span>
<span class="sd">	</span>
<span class="sd">	Some variables of the :class:`rhkdata` class:</span>

<span class="sd">	:var filename: (type str) filename of the &quot;sm4&quot; file</span>
<span class="sd">	:var image: (type :py:mod:`xarray` Dataset) Dataset containing the image data</span>
<span class="sd">	:var spectra: (type :py:mod:`xarray` Dataset) Dataset containing the spectroscopy data</span>
<span class="sd">	:var spymdata: (type :py:mod:`spym` instance) Dataset, as loaded by the :py:mod:`spym` module</span>

<span class="sd">	All the variables can be listed by calling: :class:`rhkdata.print_info`.</span>

<span class="sd">	.. note::</span>
<span class="sd">		If you want to skip the &quot;flatten&quot; filter of the topography images, use: `loadraw = True`.</span>
<span class="sd">	</span>
<span class="sd">	:Example:</span>
<span class="sd">		</span>
<span class="sd">		.. code-block:: python</span>

<span class="sd">			import rhkpy</span>

<span class="sd">			# Load dI/dV spectra, measured along a line</span>
<span class="sd">			filename = &#39;linespectra.sm4&#39;</span>
<span class="sd">			linespec = rhkpy.rhkdata(filename)</span>

<span class="sd">			# display the contents of the spectroscopy `xarray` instance</span>
<span class="sd">			linespec.spectra</span>
<span class="sd">			&lt;xarray.Dataset&gt;</span>
<span class="sd">			Dimensions:      (bias: 501, dist: 64, repetitions: 1, biasscandir: 2)</span>
<span class="sd">			Coordinates:</span>
<span class="sd">			* bias         (bias) float64 0.5 0.498 0.496 0.494 ... -0.496 -0.498 -0.5</span>
<span class="sd">			* dist         (dist) float64 0.0 0.5279 1.056 1.584 ... 32.2 32.73 33.26</span>
<span class="sd">			* repetitions  (repetitions) int32 0</span>
<span class="sd">			* biasscandir  (biasscandir) &lt;U5 &#39;left&#39; &#39;right&#39;</span>
<span class="sd">			Data variables:</span>
<span class="sd">				lia          (bias, dist, repetitions, biasscandir) float64 3.585 ... 5.185</span>
<span class="sd">				current      (bias, dist, repetitions, biasscandir) float64 99.49 ... -132.7</span>
<span class="sd">				x            (dist) float64 -37.48 -36.97 -36.45 ... -5.902 -5.384 -4.866</span>
<span class="sd">				y            (dist) float64 -173.5 -173.6 -173.7 ... -179.7 -179.9 -180.0</span>
<span class="sd">			Attributes: (12/15)</span>
<span class="sd">				filename:           line_9K_ABC6_2020_11_01_12_12_27_213.sm4</span>
<span class="sd">				bias:               0.49999988</span>
<span class="sd">				bias units:         V</span>
<span class="sd">				setpoint:           99.99999439624929</span>
<span class="sd">				setpoint units:     pA</span>
<span class="sd">				measurement date:   11/01/20</span>
<span class="sd">				...                 ...</span>
<span class="sd">				LI amplitude unit:  mV</span>
<span class="sd">				LI frequency:       1300.0</span>
<span class="sd">				LI frequency unit:  Hz</span>
<span class="sd">				LI phase:           -102.9999998</span>
<span class="sd">				datatype:           line</span>
<span class="sd">				spectype:           iv</span>

<span class="sd">			# select the dI/dV signal (lia) and average the</span>
<span class="sd">			# forward and backward bias sweeps and repetitions</span>
<span class="sd">			linespec_avg = linespec.spectra.lia.mean(dim = [&#39;biasscandir&#39;, &#39;repetitions&#39;])</span>

<span class="sd">			# plot the dI/dV values along the remaining coordinates: bias, dist</span>
<span class="sd">			linespec_avg.plot()</span>

<span class="sd">	&quot;&quot;&quot;</span>
	<span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">repetitions</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">alternate</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">loadraw</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Initialize the :class:`rhkdata` instance</span>
<span class="sd">		&quot;&quot;&quot;</span>		

		<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">alternate</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
			<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;alternate needs to be a bool variable: True or False. Default is True&quot;</span><span class="p">)</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">loadraw</span> <span class="o">=</span> <span class="n">loadraw</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">datatype</span> <span class="o">=</span> <span class="kc">None</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">spectype</span> <span class="o">=</span> <span class="kc">None</span>

		<span class="c1"># Boolean value, True if alternate scan directions is turned on</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">alternate</span> <span class="o">=</span> <span class="n">alternate</span>

		<span class="c1"># Load the data using spym</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">spymdata</span> <span class="o">=</span> <span class="n">load_spym</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spymdata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="k">return</span>

		<span class="c1"># check software version. Not tested for MinorVer &lt; 6</span>
		<span class="n">l</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spymdata</span><span class="p">[</span><span class="n">l</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_MinorVer&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">:</span>
			<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;stmdatastruct not tested for RHK Rev version &lt; 6. Some things might not work as expected.&#39;</span><span class="p">)</span>

		<span class="c1"># check type of data and spectra contained in the file</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">datatype</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectype</span> <span class="o">=</span> <span class="n">_checkdatatype</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

		<span class="c1"># number of spectra at a tip position</span>
		<span class="c1"># default value is 0, if this is changed, the code will use the given value, othewise it will try to infer the number of repetitions from the number of identical tip positions</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">datatype</span> <span class="o">!=</span> <span class="s1">&#39;image&#39;</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">repetitions</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
				<span class="c1"># overwrite the default value and the value inferred from tip coordinates</span>
				<span class="c1"># check if parameters passed to the class are valid</span>
				<span class="k">if</span> <span class="n">repetitions</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
					<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;repetitions needs to be an integer, with a value of 1 or above. Default is 1&quot;</span><span class="p">)</span>
				<span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">repetitions</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
					<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;repetitions needs to be an integer. Default is 1&quot;</span><span class="p">)</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">repetitions</span> <span class="o">=</span> <span class="n">repetitions</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="c1"># determine the number of repetitions from the number of indentical tip coordinates in the beginning of RHK_SpecDrift_Xcoord</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">repetitions</span> <span class="o">=</span> <span class="n">_checkrepetitions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">repetitions</span> <span class="o">=</span> <span class="n">repetitions</span>

		<span class="c1"># load data into xarray, for all data types</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">datatype</span> <span class="o">==</span> <span class="s1">&#39;map&#39;</span><span class="p">:</span>
			<span class="bp">self</span> <span class="o">=</span> <span class="n">_load_specmap</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
		<span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">datatype</span> <span class="o">==</span> <span class="s1">&#39;line&#39;</span><span class="p">:</span>
			<span class="bp">self</span> <span class="o">=</span> <span class="n">_load_line</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
		<span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">datatype</span> <span class="o">==</span> <span class="s1">&#39;spec&#39;</span><span class="p">:</span>
			<span class="bp">self</span> <span class="o">=</span> <span class="n">_load_spec</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
		<span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">datatype</span> <span class="o">==</span> <span class="s1">&#39;image&#39;</span><span class="p">:</span>
			<span class="bp">self</span> <span class="o">=</span> <span class="n">_load_image</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

<div class="viewcode-block" id="rhkdata.mrep">
<a class="viewcode-back" href="../../rhkpy.html#rhkpy.rhkpy_loader.rhkdata.mrep">[docs]</a>
	<span class="k">def</span> <span class="nf">mrep</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Returns a new instance of :class:`rhkdata`, with the data averaged (using :py:mod:`xarray.Variable.mean`) along the &#39;repetitions&#39; coordinate.</span>
<span class="sd">		Meant to be shorthand for: ``rhkdata_instance.spectra.mean(dim = &#39;repetitions&#39;)``.</span>

<span class="sd">		:return: :class:`rhkdata` instance</span>
<span class="sd">		:rtype: :class:`rhkdata`</span>
<span class="sd">		&quot;&quot;&quot;</span>		
		<span class="c1"># function to take the mean along the repetitions coordinate</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">datatype</span> <span class="o">==</span> <span class="s1">&#39;image&#39;</span><span class="p">:</span>
			<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;An image instance doesn</span><span class="se">\&#39;</span><span class="s1">t have repetitions.&#39;</span><span class="p">)</span>
			<span class="k">return</span>
		<span class="n">newdata</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
		<span class="n">newdata</span><span class="o">.</span><span class="n">spectra</span> <span class="o">=</span> <span class="n">newdata</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span> <span class="o">=</span> <span class="s1">&#39;repetitions&#39;</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">newdata</span></div>


<div class="viewcode-block" id="rhkdata.msw">
<a class="viewcode-back" href="../../rhkpy.html#rhkpy.rhkpy_loader.rhkdata.msw">[docs]</a>
	<span class="k">def</span> <span class="nf">msw</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Returns a new instance of :class:`rhkdata`, with the data averaged (using :py:mod:`xarray.Variable.mean`) along the &#39;biasscandir&#39; or &#39;zscandir&#39; coordinate.</span>
<span class="sd">		Meant to be shorthand for: ``rhkdata_instance.spectra.mean(dim = &#39;biasscandir&#39;)``, or ``rhkdata_instance.spectra.mean(dim = &#39;zscandir&#39;)``.</span>

<span class="sd">		:return: :class:`rhkdata` instance</span>
<span class="sd">		:rtype: :class:`rhkdata`</span>
<span class="sd">		&quot;&quot;&quot;</span>		
		<span class="c1"># function to take the mean along the biasscan coordinate</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">datatype</span> <span class="o">==</span> <span class="s1">&#39;image&#39;</span><span class="p">:</span>
			<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;An image instance doesn</span><span class="se">\&#39;</span><span class="s1">t have biasscandir or zscandir.&#39;</span><span class="p">)</span>
			<span class="k">return</span>
		<span class="n">newdata</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectype</span> <span class="o">==</span> <span class="s1">&#39;iv&#39;</span><span class="p">:</span>
			<span class="n">newdata</span><span class="o">.</span><span class="n">spectra</span> <span class="o">=</span> <span class="n">newdata</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span> <span class="o">=</span> <span class="s1">&#39;biasscandir&#39;</span><span class="p">)</span>
		<span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectype</span> <span class="o">==</span> <span class="s1">&#39;iz&#39;</span><span class="p">:</span>
			<span class="n">newdata</span><span class="o">.</span><span class="n">spectra</span> <span class="o">=</span> <span class="n">newdata</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span> <span class="o">=</span> <span class="s1">&#39;zscandir&#39;</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">newdata</span></div>


<div class="viewcode-block" id="rhkdata.print_info">
<a class="viewcode-back" href="../../rhkpy.html#rhkpy.rhkpy_loader.rhkdata.print_info">[docs]</a>
	<span class="k">def</span> <span class="nf">print_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;List the variables of the :class:`rhkdata` instance.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
			<span class="nb">print</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
		<span class="k">if</span> <span class="s1">&#39;image&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
			<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">image:&#39;</span><span class="p">)</span>
			<span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">data_vars</span><span class="p">:</span>
				<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
		<span class="k">if</span> <span class="s1">&#39;spectra&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
			<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">spectra:&#39;</span><span class="p">)</span>
			<span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">data_vars</span><span class="p">:</span>
				<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span></div>

		<span class="c1"># print(&#39;\nspymdata:&#39;)</span>
		<span class="c1"># for item in self.spymdata:</span>
		<span class="c1"># 	print(&#39;\t&#39;, item)</span>


<div class="viewcode-block" id="rhkdata.coord_to_absolute">
<a class="viewcode-back" href="../../rhkpy.html#rhkpy.rhkpy_loader.rhkdata.coord_to_absolute">[docs]</a>
	<span class="k">def</span> <span class="nf">coord_to_absolute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Returns a new :class:`rhkdata` instance, with the coordinates updated to reflect the abolute tip position. This includes X, Y offset and rotation.</span>

<span class="sd">		:return: :class:`rhkdata` instance, with the same data and metadata, but the :class:`rhkdata.image`, :py:mod:`xarray` variable coordinates shifted to absolute tip positions.</span>
<span class="sd">		:rtype: :class:`rhkdata` instance</span>

<span class="sd">		:Example:</span>
<span class="sd">		</span>
<span class="sd">		.. code-block:: python</span>

<span class="sd">			import rhkpy</span>

<span class="sd">			m = rhkpy.rhkdata(&#39;didv map.sm4&#39;)</span>

<span class="sd">			# Take the `rhkdata` instance (image or map): `m`,</span>
<span class="sd">			# and convert the image coordinates to absolute values</span>
<span class="sd">			m_abs = m.coord_to_absolute()</span>

<span class="sd">			# coordinates of the instance `m`</span>
<span class="sd">			# We can see it runs from 0 to 100 nm</span>
<span class="sd">			print(m.image.x.min().data, m.image.x.max().data)</span>
<span class="sd">			0.0 100.0</span>

<span class="sd">			# check the same corrdinate for the new `m_abs`</span>
<span class="sd">			print(m_abs.image.x.min().data, m_abs.image.x.max().data)</span>
<span class="sd">			-877.0008892433623 -741.0633876547834</span>

<span class="sd">			# we can see it&#39;s now shows the exact tip position</span>
<span class="sd">			# the image is also rotated, as the &quot;scan angle&quot; attribute shows</span>
<span class="sd">			m_abs.image.attrs[&#39;scan angle&#39;]</span>
<span class="sd">			30.0</span>
<span class="sd">			</span>
<span class="sd">			# plot the rotated and offset image</span>
<span class="sd">			m_abs.image.topography.sel(scandir = &#39;forward&#39;).plot()</span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="c1"># check if &#39;image&#39; is present</span>
		<span class="k">if</span> <span class="s1">&#39;image&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
			<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;This `rhkdata` instance does not contain an image&#39;</span><span class="p">)</span>
			<span class="k">return</span>
		
		<span class="c1"># copy the current instance</span>
		<span class="n">rhkdataobj_new</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

		<span class="c1"># update the coordinates</span>
		<span class="n">rhkdataobj_new</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">coord_to_absolute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">)</span>

		<span class="k">return</span> <span class="n">rhkdataobj_new</span></div>



<div class="viewcode-block" id="rhkdata.polyflatten">
<a class="viewcode-back" href="../../rhkpy.html#rhkpy.rhkpy_loader.rhkdata.polyflatten">[docs]</a>
	<span class="k">def</span> <span class="nf">polyflatten</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Uses :func:`~rhkpy.rhkpy_process.polyflatten` to flatten the selected datafield in the :class:`rhkdata` instance.</span>
<span class="sd">		All keywords accepted by :func:`~rhkpy.rhkpy_process.polyflatten` can be passed.</span>

<span class="sd">		:return: :class:`rhdata` instance, with the selected ``field_type`` flattened. Default ``field_type`` = &#39;topography&#39;.</span>
<span class="sd">		:rtype: :class:`rhdata` instance</span>
<span class="sd">		&quot;&quot;&quot;</span>	

		<span class="c1"># check if &#39;image&#39; is present</span>
		<span class="k">if</span> <span class="s1">&#39;image&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
			<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;This `rhkdata` instance does not contain an image&#39;</span><span class="p">)</span>
			<span class="k">return</span>
		<span class="c1"># make a copy of the instance</span>
		<span class="n">flattened_rhkdataobj</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
		<span class="c1"># apply flatten to the copy</span>
		<span class="n">flattened_rhkdataobj</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">polyflatten</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

		<span class="k">return</span> <span class="n">flattened_rhkdataobj</span></div>


	
<div class="viewcode-block" id="rhkdata.qplot">
<a class="viewcode-back" href="../../rhkpy.html#rhkpy.rhkpy_loader.rhkdata.qplot">[docs]</a>
	<span class="k">def</span> <span class="nf">qplot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Quick plot of the :class:`rhkdata` instance</span>

<span class="sd">		:param width: set size of plot, defaults to None</span>
<span class="sd">		:type width: float, optional</span>

<span class="sd">		The colorscales used for density plots can be specified by the keywords below.</span>
<span class="sd">		For possible colorscale options see the `HoloViews colormaps &lt;https://holoviews.org/user_guide/Colormaps.html&gt;`_.</span>

<span class="sd">		:param cmap_topo: topography colorscale, defaults to &#39;fire&#39;</span>
<span class="sd">		:type cmap_topo: str, optional</span>
<span class="sd">		:param cmap_spec: colorscale for plotting dI/dV data, defaults to &#39;viridis&#39;</span>
<span class="sd">		:type cmap_spec: str, optional</span>

<span class="sd">		:return: :py:mod:`panel` plot</span>
<span class="sd">		:rtype: :py:mod:`panel`</span>
<span class="sd">		&quot;&quot;&quot;</span>			
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">datatype</span> <span class="o">==</span> <span class="s1">&#39;image&#39;</span><span class="p">:</span>
			<span class="n">topo_plot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_qplot_topo</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
			<span class="n">lia_plot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_qplot_lia</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
			<span class="n">final_plot</span> <span class="o">=</span> <span class="n">pn</span><span class="o">.</span><span class="n">Row</span><span class="p">(</span><span class="n">pn</span><span class="o">.</span><span class="n">panel</span><span class="p">(</span><span class="n">topo_plot</span><span class="p">),</span> <span class="n">pn</span><span class="o">.</span><span class="n">panel</span><span class="p">(</span><span class="n">lia_plot</span><span class="p">))</span>
		<span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">datatype</span> <span class="o">==</span> <span class="s1">&#39;map&#39;</span><span class="p">:</span>
			<span class="c1"># if the rhkdata instance is &#39;map&#39;</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectype</span> <span class="o">==</span> <span class="s1">&#39;iv&#39;</span><span class="p">:</span>
				<span class="n">specplot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_qplot_map_iv</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
			<span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectype</span> <span class="o">==</span> <span class="s1">&#39;iz&#39;</span><span class="p">:</span>
				<span class="n">specplot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_qplot_map_iz</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
			<span class="c1"># plot the topography</span>
			<span class="n">topoplot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_qplot_topo</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
			<span class="c1"># adjust options</span>
			<span class="n">topoplot</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span><span class="n">frame_width</span> <span class="o">=</span> <span class="n">width</span><span class="p">)</span>
			<span class="n">specplot</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span><span class="n">frame_width</span> <span class="o">=</span> <span class="n">width</span><span class="p">)</span>
			<span class="c1"># separate the plots and the widget into panels, so I can place the widget</span>
			<span class="n">topo_static</span> <span class="o">=</span> <span class="n">pn</span><span class="o">.</span><span class="n">panel</span><span class="p">(</span><span class="n">topoplot</span><span class="p">)</span>
			<span class="n">spec_dynamic</span> <span class="o">=</span> <span class="n">pn</span><span class="o">.</span><span class="n">panel</span><span class="p">(</span><span class="n">specplot</span><span class="p">)</span>
			<span class="c1"># extract the widget</span>
			<span class="n">widget_panel</span> <span class="o">=</span> <span class="n">spec_dynamic</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
			<span class="n">specplot_static</span> <span class="o">=</span> <span class="n">spec_dynamic</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
			<span class="c1"># combined plot</span>
			<span class="n">final_plot</span> <span class="o">=</span> <span class="n">pn</span><span class="o">.</span><span class="n">Row</span><span class="p">(</span><span class="n">topo_static</span><span class="p">,</span> <span class="n">pn</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">widget_panel</span><span class="p">,</span> <span class="n">specplot_static</span><span class="p">))</span>
		<span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">datatype</span> <span class="o">==</span> <span class="s1">&#39;line&#39;</span><span class="p">:</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectype</span> <span class="o">==</span> <span class="s1">&#39;iv&#39;</span><span class="p">:</span>
				<span class="n">specplot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_qplot_line_iv</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
				<span class="c1"># plot a selected spectrum along the dist dimensions</span>
				<span class="n">combined</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_qplot_line_spec_iv</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
				<span class="c1"># if width parameter is specified, set the size of the plots</span>
				<span class="k">if</span> <span class="n">width</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
					<span class="n">twod_plot_panel</span> <span class="o">=</span> <span class="n">pn</span><span class="o">.</span><span class="n">panel</span><span class="p">(</span><span class="n">specplot</span><span class="p">)</span>
					<span class="n">combined_panel</span> <span class="o">=</span> <span class="n">pn</span><span class="o">.</span><span class="n">panel</span><span class="p">(</span><span class="n">combined</span><span class="p">)</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">twod_plot_panel</span> <span class="o">=</span> <span class="n">pn</span><span class="o">.</span><span class="n">panel</span><span class="p">(</span><span class="n">specplot</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span><span class="n">frame_width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.8</span><span class="o">*</span><span class="n">width</span><span class="p">)))</span>
					<span class="n">combined_panel</span> <span class="o">=</span> <span class="n">pn</span><span class="o">.</span><span class="n">panel</span><span class="p">(</span><span class="n">combined</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span><span class="n">frame_width</span> <span class="o">=</span> <span class="n">width</span><span class="p">))</span>
				<span class="c1"># separate the widget and plot into panels</span>
				<span class="n">plot_panel</span> <span class="o">=</span> <span class="n">combined_panel</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
				<span class="n">plot_widget</span> <span class="o">=</span> <span class="n">combined_panel</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
				<span class="c1"># combined plot</span>
				<span class="n">final_plot</span> <span class="o">=</span> <span class="n">pn</span><span class="o">.</span><span class="n">Row</span><span class="p">(</span><span class="n">twod_plot_panel</span><span class="p">,</span> <span class="n">pn</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">plot_widget</span><span class="p">,</span> <span class="n">plot_panel</span><span class="p">))</span>
			<span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectype</span> <span class="o">==</span> <span class="s1">&#39;iz&#39;</span><span class="p">:</span>
				<span class="c1"># take the mean of the spectra in a point and plot it</span>
				<span class="n">specplot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_qplot_line_iz</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
				<span class="n">combined</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_qplot_line_spec_iz</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
				<span class="c1"># if width parameter is specified, set the size of the plots</span>
				<span class="k">if</span> <span class="n">width</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
					<span class="n">twod_plot_panel</span> <span class="o">=</span> <span class="n">pn</span><span class="o">.</span><span class="n">panel</span><span class="p">(</span><span class="n">specplot</span><span class="p">)</span>
					<span class="n">combined_panel</span> <span class="o">=</span> <span class="n">pn</span><span class="o">.</span><span class="n">panel</span><span class="p">(</span><span class="n">combined</span><span class="p">)</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">twod_plot_panel</span> <span class="o">=</span> <span class="n">pn</span><span class="o">.</span><span class="n">panel</span><span class="p">(</span><span class="n">specplot</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span><span class="n">frame_width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.8</span><span class="o">*</span><span class="n">width</span><span class="p">)))</span>
					<span class="n">combined_panel</span> <span class="o">=</span> <span class="n">pn</span><span class="o">.</span><span class="n">panel</span><span class="p">(</span><span class="n">combined</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span><span class="n">frame_width</span> <span class="o">=</span> <span class="n">width</span><span class="p">))</span>
				<span class="c1"># separate the widget and plot into panels</span>
				<span class="n">plot_panel</span> <span class="o">=</span> <span class="n">combined_panel</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
				<span class="n">plot_widget</span> <span class="o">=</span> <span class="n">combined_panel</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
				<span class="c1"># combined plot</span>
				<span class="n">final_plot</span> <span class="o">=</span> <span class="n">pn</span><span class="o">.</span><span class="n">Row</span><span class="p">(</span><span class="n">twod_plot_panel</span><span class="p">,</span> <span class="n">pn</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">plot_widget</span><span class="p">,</span> <span class="n">plot_panel</span><span class="p">))</span>

		<span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">datatype</span> <span class="o">==</span> <span class="s1">&#39;spec&#39;</span><span class="p">:</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectype</span> <span class="o">==</span> <span class="s1">&#39;iv&#39;</span><span class="p">:</span>
				<span class="n">leftpanel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_qplot_spec_iv_lia</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
				<span class="n">rightpanel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_qplot_spec_iv_curr</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
				<span class="n">left_panel</span> <span class="o">=</span> <span class="n">pn</span><span class="o">.</span><span class="n">panel</span><span class="p">(</span><span class="n">leftpanel</span><span class="p">)</span>
				<span class="n">right_panel</span> <span class="o">=</span> <span class="n">pn</span><span class="o">.</span><span class="n">panel</span><span class="p">(</span><span class="n">rightpanel</span><span class="p">)</span>
				<span class="n">final_plot</span> <span class="o">=</span> <span class="n">pn</span><span class="o">.</span><span class="n">Row</span><span class="p">(</span><span class="n">left_panel</span><span class="p">,</span> <span class="n">right_panel</span><span class="p">)</span>
			<span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectype</span> <span class="o">==</span> <span class="s1">&#39;iz&#39;</span><span class="p">:</span>
				<span class="n">combined</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_qplot_spec_iz</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
				<span class="n">final_plot</span> <span class="o">=</span> <span class="n">pn</span><span class="o">.</span><span class="n">panel</span><span class="p">(</span><span class="n">combined</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span><span class="n">width</span> <span class="o">=</span> <span class="mi">400</span><span class="p">,</span> <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;current&#39;</span><span class="p">))</span>

		<span class="c1">## This shows the plot in a separate window</span>
		<span class="c1"># hvplot.show(topoplot)</span>
		<span class="k">return</span> <span class="n">final_plot</span></div>


	<span class="c1">## internal functions -----------------------------------------------------------------------------------------</span>
	<span class="c1">## plotting functions for qplot</span>

	<span class="k">def</span> <span class="nf">_qplot_topo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmap_topo</span> <span class="o">=</span> <span class="s1">&#39;fire&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Plotting topography data using :py:mod:`hvplot`.</span>

<span class="sd">		:param cmap_topo: colorscale used for topography data, defaults to &#39;fire&#39;</span>
<span class="sd">		:type cmap_topo: str, optional</span>
<span class="sd">		</span>
<span class="sd">		:return: :py:mod:`holoviews` plot</span>
<span class="sd">		:rtype: :py:mod:`holoviews`</span>
<span class="sd">		&quot;&quot;&quot;</span>	
		<span class="c1"># The backward direction should be plotted, since this is the direction in which the tip moves, when the spectroscopy data is measured.</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">topography</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">image</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="n">cmap_topo</span><span class="p">,</span> <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;topography backward&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">_qplot_lia</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmap_spec</span> <span class="o">=</span> <span class="s1">&#39;viridis&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Plotting dI/dV image data using :py:mod:`hvplot`.</span>

<span class="sd">		:param cmap_spec: colorscale used for dI/dV data, defaults to &#39;viridis&#39;</span>
<span class="sd">		:type cmap_spec: str, optional</span>
<span class="sd">		</span>
<span class="sd">		:return: :py:mod:`holoviews` plot</span>
<span class="sd">		:rtype: :py:mod:`holoviews`</span>
<span class="sd">		&quot;&quot;&quot;</span>	
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">lia</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">image</span><span class="p">(</span><span class="n">cmap</span> <span class="o">=</span> <span class="n">cmap_spec</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;dI/dV backward&#39;</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">_qplot_map_iv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmap_spec</span> <span class="o">=</span> <span class="s1">&#39;viridis&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Plotting dI/dV map data using :py:mod:`hvplot`.</span>
<span class="sd">		The mean values (biasscandir and repetitions) of the dI/dV signal are plotted on the density plot.</span>

<span class="sd">		:param cmap_spec: colorscale used for dI/dV data, defaults to &#39;viridis&#39;</span>
<span class="sd">		:type cmap_spec: str, optional</span>
<span class="sd">		</span>
<span class="sd">		:return: :py:mod:`holoviews` plot</span>
<span class="sd">		:rtype: :py:mod:`holoviews`</span>
<span class="sd">		&quot;&quot;&quot;</span>	
		<span class="c1"># take the mean of the spectra in a point and plot it</span>
		<span class="n">meanmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;repetitions&#39;</span><span class="p">,</span> <span class="s1">&#39;biasscandir&#39;</span><span class="p">])</span>
		<span class="c1"># select the lia</span>
		<span class="n">specplot</span> <span class="o">=</span> <span class="n">meanmap</span><span class="o">.</span><span class="n">lia</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">image</span><span class="p">(</span>
			<span class="n">x</span> <span class="o">=</span> <span class="s1">&#39;specpos_x&#39;</span><span class="p">,</span>
			<span class="n">y</span> <span class="o">=</span> <span class="s1">&#39;specpos_y&#39;</span><span class="p">,</span>
			<span class="n">groupby</span> <span class="o">=</span> <span class="s1">&#39;bias&#39;</span><span class="p">,</span>
			<span class="n">cmap</span> <span class="o">=</span> <span class="n">cmap_spec</span><span class="p">,</span>
			<span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;dI/dV map&#39;</span>
		<span class="p">)</span>
		<span class="c1"># holoviews plot</span>
		<span class="k">return</span> <span class="n">specplot</span>
	
	<span class="k">def</span> <span class="nf">_qplot_map_iz</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmap_spec</span> <span class="o">=</span> <span class="s1">&#39;viridis&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Plotting I(z) map data using :py:mod:`hvplot`.</span>

<span class="sd">		:param cmap_spec: colorscale used for I(z) data, defaults to &#39;viridis&#39;</span>
<span class="sd">		:type cmap_spec: str, optional</span>
<span class="sd">		</span>
<span class="sd">		:return: :py:mod:`holoviews` plot</span>
<span class="sd">		:rtype: :py:mod:`holoviews`</span>
<span class="sd">		&quot;&quot;&quot;</span>	
		<span class="c1"># take the mean of the spectra in a point and plot it</span>
		<span class="n">meanmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;repetitions&#39;</span><span class="p">,</span> <span class="s1">&#39;zscandir&#39;</span><span class="p">])</span>
		<span class="n">specplot</span> <span class="o">=</span> <span class="n">meanmap</span><span class="o">.</span><span class="n">current</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">image</span><span class="p">(</span>
			<span class="n">x</span> <span class="o">=</span> <span class="s1">&#39;specpos_x&#39;</span><span class="p">,</span>
			<span class="n">y</span> <span class="o">=</span> <span class="s1">&#39;specpos_y&#39;</span><span class="p">,</span>
			<span class="n">groupby</span> <span class="o">=</span> <span class="s1">&#39;z&#39;</span><span class="p">,</span>
			<span class="n">cmap</span> <span class="o">=</span> <span class="n">cmap_spec</span><span class="p">,</span>
			<span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;I(z) map&#39;</span>
		<span class="p">)</span>
		<span class="k">return</span> <span class="n">specplot</span>

	<span class="k">def</span> <span class="nf">_qplot_line_iv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmap_spec</span> <span class="o">=</span> <span class="s1">&#39;viridis&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Plotting dI/dV line data on a density plot (bias vs distance), using :py:mod:`hvplot`.</span>
<span class="sd">		The mean values of the dI/dV signal are plotted on the density plot.</span>

<span class="sd">		:param cmap_spec: colorscale used for dI/dV data, defaults to &#39;viridis&#39;</span>
<span class="sd">		:type cmap_spec: str, optional</span>
<span class="sd">		</span>
<span class="sd">		:return: :py:mod:`holoviews` plot</span>
<span class="sd">		:rtype: :py:mod:`holoviews`</span>
<span class="sd">		&quot;&quot;&quot;</span>	
		<span class="c1"># take the mean of the spectra in a point and plot it</span>
		<span class="n">meanmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;repetitions&#39;</span><span class="p">,</span> <span class="s1">&#39;biasscandir&#39;</span><span class="p">])</span>
		<span class="c1"># select the lia</span>
		<span class="n">specplot</span> <span class="o">=</span> <span class="n">meanmap</span><span class="o">.</span><span class="n">lia</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">image</span><span class="p">(</span>
			<span class="n">x</span> <span class="o">=</span> <span class="s1">&#39;bias&#39;</span><span class="p">,</span>
			<span class="n">y</span> <span class="o">=</span> <span class="s1">&#39;dist&#39;</span><span class="p">,</span>
			<span class="n">cmap</span> <span class="o">=</span> <span class="n">cmap_spec</span><span class="p">,</span>
			<span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;dI/dV line spectra&#39;</span><span class="p">,</span>
			<span class="n">aspect</span> <span class="o">=</span> <span class="mi">1</span>
		<span class="p">)</span>
		<span class="k">return</span> <span class="n">specplot</span>

	<span class="k">def</span> <span class="nf">_qplot_line_spec_iv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Plotting dI/dV spectra of a line spectroscopy instance, using :py:mod:`hvplot`.</span>

<span class="sd">		:return: :py:mod:`holoviews` plot</span>
<span class="sd">		:rtype: :py:mod:`holoviews`</span>
<span class="sd">		&quot;&quot;&quot;</span>	
		<span class="c1"># plot repetitions and biasscandir on the same plot</span>
		<span class="c1"># do the first plot, if there are more than 1 repetitions, plot the average first</span>
		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">repetitions</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
			<span class="n">lineplot_fw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">lia</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="s1">&#39;bias&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;left&#39;</span><span class="p">)</span>
			<span class="n">lineplot_bw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">lia</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="s1">&#39;bias&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;right&#39;</span><span class="p">)</span>
		<span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">repetitions</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
			<span class="n">lineplot_fw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">lia</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="s1">&#39;bias&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;LightCoral&#39;</span><span class="p">,</span> <span class="n">line_dash</span> <span class="o">=</span> <span class="s1">&#39;dotted&#39;</span><span class="p">,</span> <span class="n">line_width</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">lineplot_bw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">lia</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="s1">&#39;bias&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;LightSkyBlue&#39;</span><span class="p">,</span> <span class="n">line_dash</span> <span class="o">=</span> <span class="s1">&#39;dotted&#39;</span><span class="p">,</span> <span class="n">line_width</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">repetitions</span><span class="p">)):</span>
				<span class="c1"># iterate through the repetitions and plot on the same plot</span>
				<span class="n">lineplot_fw</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">lia</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="s1">&#39;bias&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;LightCoral&#39;</span><span class="p">,</span> <span class="n">line_dash</span> <span class="o">=</span> <span class="s1">&#39;dotted&#39;</span><span class="p">,</span> <span class="n">line_width</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">lineplot_bw</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">lia</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="s1">&#39;bias&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;LightSkyBlue&#39;</span><span class="p">,</span> <span class="n">line_dash</span> <span class="o">=</span> <span class="s1">&#39;dotted&#39;</span><span class="p">,</span> <span class="n">line_width</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">lineplot_fw</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">lia</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span> <span class="o">=</span> <span class="s1">&#39;repetitions&#39;</span><span class="p">)[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="s1">&#39;bias&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">line_width</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;avg left&#39;</span><span class="p">)</span>
			<span class="n">lineplot_bw</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">lia</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span> <span class="o">=</span> <span class="s1">&#39;repetitions&#39;</span><span class="p">)[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="s1">&#39;bias&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">line_width</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;avg right&#39;</span><span class="p">)</span>

		<span class="c1"># combine the fw and bw bias sweeps</span>
		<span class="k">return</span> <span class="n">lineplot_fw</span> <span class="o">*</span> <span class="n">lineplot_bw</span>

	<span class="k">def</span> <span class="nf">_qplot_line_iz</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmap_spec</span> <span class="o">=</span> <span class="s1">&#39;viridis&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Plotting I(z) line data on a density plot (tip height vs distance), using :py:mod:`hvplot`.</span>
<span class="sd">		The mean values of the I(z) signal are plotted.</span>

<span class="sd">		:param cmap_spec: colorscale used for dI/dV data, defaults to &#39;viridis&#39;</span>
<span class="sd">		:type cmap_spec: str, optional</span>
<span class="sd">		</span>
<span class="sd">		:return: :py:mod:`holoviews` plot</span>
<span class="sd">		:rtype: :py:mod:`holoviews`</span>
<span class="sd">		&quot;&quot;&quot;</span>	
		<span class="n">meanmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;repetitions&#39;</span><span class="p">,</span> <span class="s1">&#39;zscandir&#39;</span><span class="p">])</span>
		<span class="c1"># select the current</span>
		<span class="n">specplot</span> <span class="o">=</span> <span class="n">meanmap</span><span class="o">.</span><span class="n">current</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">image</span><span class="p">(</span>
			<span class="n">x</span> <span class="o">=</span> <span class="s1">&#39;z&#39;</span><span class="p">,</span>
			<span class="n">y</span> <span class="o">=</span> <span class="s1">&#39;dist&#39;</span><span class="p">,</span>
			<span class="n">cmap</span> <span class="o">=</span> <span class="n">cmap_spec</span><span class="p">,</span>
			<span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;I(z) line spectra&#39;</span><span class="p">,</span>
			<span class="n">aspect</span> <span class="o">=</span> <span class="mi">1</span>
		<span class="p">)</span>
		<span class="k">return</span> <span class="n">specplot</span>

	<span class="k">def</span> <span class="nf">_qplot_line_spec_iz</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Plotting I(z) spectra of a line spectroscopy instance, using :py:mod:`hvplot`.</span>

<span class="sd">		:return: :py:mod:`holoviews` plot</span>
<span class="sd">		:rtype: :py:mod:`holoviews`</span>
<span class="sd">		&quot;&quot;&quot;</span>	
		<span class="c1"># plot repetitions and zscandir on the same plot</span>
		<span class="c1"># if there are more repetitions, the first plot will be the average</span>
		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">repetitions</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
			<span class="n">lineplot_fw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">current</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;up&#39;</span><span class="p">)</span>
			<span class="n">lineplot_bw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">current</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;down&#39;</span><span class="p">)</span>
		<span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">repetitions</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
			<span class="n">lineplot_fw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">current</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;LightCoral&#39;</span><span class="p">,</span> <span class="n">line_dash</span> <span class="o">=</span> <span class="s1">&#39;dotted&#39;</span><span class="p">,</span> <span class="n">line_width</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">lineplot_bw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">current</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;LightSkyBlue&#39;</span><span class="p">,</span> <span class="n">line_dash</span> <span class="o">=</span> <span class="s1">&#39;dotted&#39;</span><span class="p">,</span> <span class="n">line_width</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">repetitions</span><span class="p">)):</span>
				<span class="c1"># iterate through the repetitions and plot on the same plot</span>
				<span class="n">lineplot_fw</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">current</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;LightCoral&#39;</span><span class="p">,</span> <span class="n">line_dash</span> <span class="o">=</span> <span class="s1">&#39;dotted&#39;</span><span class="p">,</span> <span class="n">line_width</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">lineplot_bw</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">current</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;LightSkyBlue&#39;</span><span class="p">,</span> <span class="n">line_dash</span> <span class="o">=</span> <span class="s1">&#39;dotted&#39;</span><span class="p">,</span> <span class="n">line_width</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">lineplot_fw</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">current</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span> <span class="o">=</span> <span class="s1">&#39;repetitions&#39;</span><span class="p">)[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">line_width</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;avg up&#39;</span><span class="p">)</span>
			<span class="n">lineplot_bw</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">current</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span> <span class="o">=</span> <span class="s1">&#39;repetitions&#39;</span><span class="p">)[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">line_width</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;avg down&#39;</span><span class="p">)</span>

		<span class="c1"># combine the fw and bw z sweeps</span>
		<span class="k">return</span> <span class="n">lineplot_fw</span> <span class="o">*</span> <span class="n">lineplot_bw</span>

	<span class="k">def</span> <span class="nf">_qplot_spec_iv_lia</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Plotting the dI/dV signal of a single spectrum instance, using :py:mod:`hvplot`.</span>

<span class="sd">		:return: :py:mod:`holoviews` plot</span>
<span class="sd">		:rtype: :py:mod:`holoviews`</span>
<span class="sd">		&quot;&quot;&quot;</span>	
		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">repetitions</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
			<span class="n">liaplot_fw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">lia</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="s1">&#39;bias&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;left&#39;</span><span class="p">)</span>
			<span class="n">liaplot_bw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">lia</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="s1">&#39;bias&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;right&#39;</span><span class="p">)</span>
		<span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">repetitions</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
			<span class="n">liaplot_fw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">lia</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="s1">&#39;bias&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;LightCoral&#39;</span><span class="p">,</span> <span class="n">line_dash</span> <span class="o">=</span> <span class="s1">&#39;dotted&#39;</span><span class="p">,</span> <span class="n">line_width</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">liaplot_bw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">lia</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="s1">&#39;bias&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;LightSkyBlue&#39;</span><span class="p">,</span> <span class="n">line_dash</span> <span class="o">=</span> <span class="s1">&#39;dotted&#39;</span><span class="p">,</span> <span class="n">line_width</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">repetitions</span><span class="p">)):</span>
				<span class="c1"># iterate through the repetitions and plot on the same plot</span>
				<span class="n">liaplot_fw</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">lia</span><span class="p">[:,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="s1">&#39;bias&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;LightCoral&#39;</span><span class="p">,</span> <span class="n">line_dash</span> <span class="o">=</span> <span class="s1">&#39;dotted&#39;</span><span class="p">,</span> <span class="n">line_width</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">liaplot_bw</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">lia</span><span class="p">[:,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="s1">&#39;bias&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;LightSkyBlue&#39;</span><span class="p">,</span> <span class="n">line_dash</span> <span class="o">=</span> <span class="s1">&#39;dotted&#39;</span><span class="p">,</span> <span class="n">line_width</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">liaplot_fw</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">lia</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span> <span class="o">=</span> <span class="s1">&#39;repetitions&#39;</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="s1">&#39;bias&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">line_width</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;avg left&#39;</span><span class="p">)</span>
			<span class="n">liaplot_bw</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">lia</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span> <span class="o">=</span> <span class="s1">&#39;repetitions&#39;</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="s1">&#39;bias&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">line_width</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;avg right&#39;</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">liaplot_fw</span><span class="o">*</span><span class="n">liaplot_bw</span><span class="p">)</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span><span class="n">width</span> <span class="o">=</span> <span class="mi">400</span><span class="p">,</span> <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;dI/dV&#39;</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">_qplot_spec_iv_curr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Plotting the current signal of a single spectrum instance, using :py:mod:`hvplot`.</span>

<span class="sd">		:return: :py:mod:`holoviews` plot</span>
<span class="sd">		:rtype: :py:mod:`holoviews`</span>
<span class="sd">		&quot;&quot;&quot;</span>	
		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">repetitions</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
			<span class="n">currplot_fw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">current</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="s1">&#39;bias&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;left&#39;</span><span class="p">)</span>
			<span class="n">currplot_bw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">current</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="s1">&#39;bias&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;right&#39;</span><span class="p">)</span>
		<span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">repetitions</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
			<span class="n">currplot_fw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">current</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="s1">&#39;bias&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;LightCoral&#39;</span><span class="p">,</span> <span class="n">line_dash</span> <span class="o">=</span> <span class="s1">&#39;dotted&#39;</span><span class="p">,</span> <span class="n">line_width</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">currplot_bw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">current</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="s1">&#39;bias&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;LightSkyBlue&#39;</span><span class="p">,</span> <span class="n">line_dash</span> <span class="o">=</span> <span class="s1">&#39;dotted&#39;</span><span class="p">,</span> <span class="n">line_width</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">repetitions</span><span class="p">)):</span>
				<span class="c1"># iterate through the repetitions and plot on the same plot</span>
				<span class="n">currplot_fw</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">current</span><span class="p">[:,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="s1">&#39;bias&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;LightCoral&#39;</span><span class="p">,</span> <span class="n">line_dash</span> <span class="o">=</span> <span class="s1">&#39;dotted&#39;</span><span class="p">,</span> <span class="n">line_width</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">currplot_bw</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">current</span><span class="p">[:,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="s1">&#39;bias&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;LightSkyBlue&#39;</span><span class="p">,</span> <span class="n">line_dash</span> <span class="o">=</span> <span class="s1">&#39;dotted&#39;</span><span class="p">,</span> <span class="n">line_width</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">currplot_fw</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">current</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span> <span class="o">=</span> <span class="s1">&#39;repetitions&#39;</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="s1">&#39;bias&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">line_width</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;avg left&#39;</span><span class="p">)</span>
			<span class="n">currplot_bw</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">current</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span> <span class="o">=</span> <span class="s1">&#39;repetitions&#39;</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="s1">&#39;bias&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">line_width</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;avg right&#39;</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">currplot_fw</span><span class="o">*</span><span class="n">currplot_bw</span><span class="p">)</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span><span class="n">width</span> <span class="o">=</span> <span class="mi">400</span><span class="p">,</span> <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;current&#39;</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">_qplot_spec_iz</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Plotting an I(z) single spectrum instance, using :py:mod:`hvplot`.</span>

<span class="sd">		:return: :py:mod:`holoviews` plot</span>
<span class="sd">		:rtype: :py:mod:`holoviews`</span>
<span class="sd">		&quot;&quot;&quot;</span>	
		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">repetitions</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
			<span class="n">specplot_up</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">current</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;up&#39;</span><span class="p">)</span>
			<span class="n">specplot_down</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">current</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;down&#39;</span><span class="p">)</span>
		<span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">repetitions</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
			<span class="n">specplot_up</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">current</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;LightCoral&#39;</span><span class="p">,</span> <span class="n">line_dash</span> <span class="o">=</span> <span class="s1">&#39;dotted&#39;</span><span class="p">,</span> <span class="n">line_width</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">specplot_down</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">current</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;LightSkyBlue&#39;</span><span class="p">,</span> <span class="n">line_dash</span> <span class="o">=</span> <span class="s1">&#39;dotted&#39;</span><span class="p">,</span> <span class="n">line_width</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">repetitions</span><span class="p">)):</span>
				<span class="c1"># iterate through the repetitions and plot on the same plot</span>
				<span class="n">specplot_up</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">current</span><span class="p">[:,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;LightCoral&#39;</span><span class="p">,</span> <span class="n">line_dash</span> <span class="o">=</span> <span class="s1">&#39;dotted&#39;</span><span class="p">,</span> <span class="n">line_width</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">specplot_down</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">current</span><span class="p">[:,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;LightSkyBlue&#39;</span><span class="p">,</span> <span class="n">line_dash</span> <span class="o">=</span> <span class="s1">&#39;dotted&#39;</span><span class="p">,</span> <span class="n">line_width</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">specplot_up</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">current</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span> <span class="o">=</span> <span class="s1">&#39;repetitions&#39;</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">line_width</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;avg up&#39;</span><span class="p">)</span>
			<span class="n">specplot_down</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">current</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span> <span class="o">=</span> <span class="s1">&#39;repetitions&#39;</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">line_width</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;avg down&#39;</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">specplot_up</span><span class="o">*</span><span class="n">specplot_down</span></div>



<div class="viewcode-block" id="load_rhksm4">
<a class="viewcode-back" href="../../rhkpy.html#rhkpy.rhkpy_loader.load_rhksm4">[docs]</a>
<span class="k">def</span> <span class="nf">load_rhksm4</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;Load the data from the .sm4 file using the old loader from spym&quot;&quot;&quot;</span>
	<span class="k">return</span> <span class="n">rhksm4</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span></div>



<div class="viewcode-block" id="load_spym">
<a class="viewcode-back" href="../../rhkpy.html#rhkpy.rhkpy_loader.load_spym">[docs]</a>
<span class="k">def</span> <span class="nf">load_spym</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;Load the data from the .sm4 file using spym&quot;&quot;&quot;</span>
	<span class="k">return</span> <span class="n">load</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span></div>


<span class="c1">## internal functions ------------------------------------------------</span>
<span class="c1">## loading -----------------------------------------------------------</span>

<span class="k">def</span> <span class="nf">_checkrepetitions</span><span class="p">(</span><span class="n">stmdata_object</span><span class="p">):</span>
	<span class="c1"># make an array of x and y coordinates</span>
	<span class="n">coordlist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span>
		<span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_SpecDrift_Xcoord&#39;</span><span class="p">]),</span>
		<span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_SpecDrift_Ycoord&#39;</span><span class="p">])</span>
	<span class="p">))</span>
	<span class="c1"># get the number of unique pairs</span>
	<span class="n">_</span><span class="p">,</span> <span class="n">counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">coordlist</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
	<span class="n">reps</span> <span class="o">=</span> <span class="n">counts</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
	<span class="n">reps</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">reps</span> <span class="o">/</span> <span class="p">(</span><span class="n">stmdata_object</span><span class="o">.</span><span class="n">alternate</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
	<span class="k">return</span> <span class="n">reps</span>

<span class="k">def</span> <span class="nf">_checkdatatype</span><span class="p">(</span><span class="n">stmdata_object</span><span class="p">):</span>
	<span class="c1"># check if the list of keys in the spym data contain &#39;Current&#39;</span>
	<span class="c1"># If yes, it is not a pure topo image</span>
	<span class="n">l</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
	<span class="k">if</span> <span class="s1">&#39;Current&#39;</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>
		<span class="c1"># it&#39;s a single spec, line spec or map</span>
		<span class="k">if</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="p">[</span><span class="s1">&#39;Current&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_PageType&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">38</span><span class="p">:</span>
			<span class="n">stmdata_object</span><span class="o">.</span><span class="n">datatype</span> <span class="o">=</span> <span class="s1">&#39;spec&#39;</span>
			<span class="c1"># determine if it&#39;s Iz or dI/dV</span>
			<span class="k">if</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="p">[</span><span class="s1">&#39;Current&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_LineType&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">7</span><span class="p">:</span>
				<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectype</span> <span class="o">=</span> <span class="s1">&#39;iv&#39;</span>
			<span class="k">elif</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="p">[</span><span class="s1">&#39;Current&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_LineType&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">8</span><span class="p">:</span>
				<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectype</span> <span class="o">=</span> <span class="s1">&#39;iz&#39;</span>
		<span class="k">elif</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="p">[</span><span class="s1">&#39;Current&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_PageType&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">16</span><span class="p">:</span>
			<span class="c1"># this can be either a line spectrum or a map</span>
			<span class="c1"># decide based on the aspect ratio of the spectroscopy tip positions</span>
			<span class="n">xcoo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="p">[</span><span class="s1">&#39;Current&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_SpecDrift_Xcoord&#39;</span><span class="p">])</span>
			<span class="n">ycoo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="p">[</span><span class="s1">&#39;Current&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_SpecDrift_Ycoord&#39;</span><span class="p">])</span>
			<span class="k">if</span> <span class="n">_aspect_ratio</span><span class="p">(</span><span class="n">xcoo</span><span class="p">,</span> <span class="n">ycoo</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
				<span class="n">stmdata_object</span><span class="o">.</span><span class="n">datatype</span> <span class="o">=</span> <span class="s1">&#39;line&#39;</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">stmdata_object</span><span class="o">.</span><span class="n">datatype</span> <span class="o">=</span> <span class="s1">&#39;map&#39;</span>
			<span class="c1"># determine if it&#39;s Iz or dI/dV</span>
			<span class="k">if</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="p">[</span><span class="s1">&#39;Current&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_LineType&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">7</span><span class="p">:</span>
				<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectype</span> <span class="o">=</span> <span class="s1">&#39;iv&#39;</span>
			<span class="k">elif</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="p">[</span><span class="s1">&#39;Current&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_LineType&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">8</span><span class="p">:</span>
				<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectype</span> <span class="o">=</span> <span class="s1">&#39;iz&#39;</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="n">stmdata_object</span><span class="o">.</span><span class="n">datatype</span> <span class="o">=</span> <span class="s1">&#39;image&#39;</span>
		<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectype</span> <span class="o">=</span> <span class="kc">None</span>
	
	<span class="k">return</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">datatype</span><span class="p">,</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectype</span>


<span class="k">def</span> <span class="nf">_aspect_ratio</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="n">xy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">eigvals</span><span class="p">,</span> <span class="n">eigvecs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eig</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">xy</span><span class="p">))</span>
    <span class="n">center</span> <span class="o">=</span> <span class="n">xy</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">val</span><span class="p">,</span> <span class="n">vec</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">eigvals</span><span class="p">,</span> <span class="n">eigvecs</span><span class="o">.</span><span class="n">T</span><span class="p">):</span>
        <span class="n">val</span> <span class="o">*=</span> <span class="mi">2</span>
        <span class="n">xcov</span><span class="p">,</span><span class="n">ycov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">center</span> <span class="o">+</span> <span class="n">val</span> <span class="o">*</span> <span class="n">vec</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">center</span> <span class="o">-</span> <span class="n">val</span> <span class="o">*</span> <span class="n">vec</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
    <span class="n">aspect</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">eigvals</span><span class="p">)</span> <span class="o">/</span> <span class="nb">min</span><span class="p">(</span><span class="n">eigvals</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">aspect</span>


<span class="k">def</span> <span class="nf">_get_filename</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
	<span class="c1"># If the string ends with a slash or backslash, remove it first</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;/</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># Then, match any character other than backslash or slash until the end of the string</span>
    <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[^/</span><span class="se">\\</span><span class="s1">]+$&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="n">match</span> <span class="k">else</span> <span class="kc">None</span>


<span class="k">def</span> <span class="nf">_load_specmap</span><span class="p">(</span><span class="n">stmdata_object</span><span class="p">):</span>
	<span class="c1"># total number of spectra in one postion of the tip</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">numberofspectra</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">stmdata_object</span><span class="o">.</span><span class="n">alternate</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">stmdata_object</span><span class="o">.</span><span class="n">repetitions</span><span class="p">)</span>
	<span class="c1"># load the image</span>
	<span class="n">stmdata_object</span> <span class="o">=</span> <span class="n">_load_image</span><span class="p">(</span><span class="n">stmdata_object</span><span class="p">)</span>

	<span class="c1"># decide if it&#39;s a dI/dV or I(z) map</span>
	<span class="k">if</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectype</span> <span class="o">==</span> <span class="s1">&#39;iv&#39;</span><span class="p">:</span>
		<span class="c1"># create a DataSet, containing the LIA and Current maps, with appropriate position coordinates</span>
		<span class="n">stmdata_object</span> <span class="o">=</span> <span class="n">_xr_map_iv</span><span class="p">(</span><span class="n">stmdata_object</span><span class="p">)</span>
		<span class="c1"># add metadata to the xarray</span>
		<span class="n">stmdata_object</span> <span class="o">=</span> <span class="n">_add_map_metadata</span><span class="p">(</span><span class="n">stmdata_object</span><span class="p">)</span>
	<span class="k">elif</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectype</span> <span class="o">==</span> <span class="s1">&#39;iz&#39;</span><span class="p">:</span>
		<span class="c1"># create xarray Dataset</span>
		<span class="n">stmdata_object</span> <span class="o">=</span> <span class="n">_xr_map_iz</span><span class="p">(</span><span class="n">stmdata_object</span><span class="p">)</span>
		<span class="c1"># add metadata to the xarray</span>
		<span class="n">stmdata_object</span> <span class="o">=</span> <span class="n">_add_map_metadata</span><span class="p">(</span><span class="n">stmdata_object</span><span class="p">)</span>
	<span class="k">return</span> <span class="n">stmdata_object</span>


<span class="k">def</span> <span class="nf">_load_line</span><span class="p">(</span><span class="n">stmdata_object</span><span class="p">):</span>
	<span class="c1"># total number of spectra in one postion of the tip</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">numberofspectra</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">stmdata_object</span><span class="o">.</span><span class="n">alternate</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">stmdata_object</span><span class="o">.</span><span class="n">repetitions</span><span class="p">)</span>
	<span class="c1"># load the image data</span>
	<span class="n">stmdata_object</span> <span class="o">=</span> <span class="n">_load_image</span><span class="p">(</span><span class="n">stmdata_object</span><span class="p">)</span>

	<span class="c1"># decide if it&#39;s a dI/dV or I(z) line</span>
	<span class="k">if</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectype</span> <span class="o">==</span> <span class="s1">&#39;iv&#39;</span><span class="p">:</span>
		<span class="n">stmdata_object</span> <span class="o">=</span> <span class="n">_xr_line_iv</span><span class="p">(</span><span class="n">stmdata_object</span><span class="p">)</span>
		<span class="n">stmdata_object</span> <span class="o">=</span> <span class="n">_add_line_metadata</span><span class="p">(</span><span class="n">stmdata_object</span><span class="p">)</span>
	<span class="k">elif</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectype</span> <span class="o">==</span> <span class="s1">&#39;iz&#39;</span><span class="p">:</span>
		<span class="n">stmdata_object</span> <span class="o">=</span> <span class="n">_xr_line_iz</span><span class="p">(</span><span class="n">stmdata_object</span><span class="p">)</span>
		<span class="n">stmdata_object</span> <span class="o">=</span> <span class="n">_add_spec_metadata</span><span class="p">(</span><span class="n">stmdata_object</span><span class="p">)</span>
	<span class="k">return</span> <span class="n">stmdata_object</span>


<span class="k">def</span> <span class="nf">_load_spec</span><span class="p">(</span><span class="n">stmdata_object</span><span class="p">):</span>
	<span class="c1"># in this case the total number of spectra can be inferred</span>
	<span class="c1"># total number of spectra in one postion of the tip</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">repetitions</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">stmdata_object</span><span class="o">.</span><span class="n">alternate</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">numberofspectra</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">stmdata_object</span><span class="o">.</span><span class="n">alternate</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">stmdata_object</span><span class="o">.</span><span class="n">repetitions</span><span class="p">)</span>

	<span class="c1"># decide if it&#39;s a dI/dV or I(z) spec</span>
	<span class="k">if</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectype</span> <span class="o">==</span> <span class="s1">&#39;iv&#39;</span><span class="p">:</span>
		<span class="n">stmdata_object</span> <span class="o">=</span> <span class="n">_xr_spec_iv</span><span class="p">(</span><span class="n">stmdata_object</span><span class="p">)</span>
		<span class="n">stmdata_object</span> <span class="o">=</span> <span class="n">_add_spec_metadata</span><span class="p">(</span><span class="n">stmdata_object</span><span class="p">)</span>
	<span class="k">elif</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectype</span> <span class="o">==</span> <span class="s1">&#39;iz&#39;</span><span class="p">:</span>
		<span class="n">stmdata_object</span> <span class="o">=</span> <span class="n">_xr_spec_iz</span><span class="p">(</span><span class="n">stmdata_object</span><span class="p">)</span>
		<span class="n">stmdata_object</span> <span class="o">=</span> <span class="n">_add_spec_metadata</span><span class="p">(</span><span class="n">stmdata_object</span><span class="p">)</span>
	<span class="k">return</span> <span class="n">stmdata_object</span>


<span class="k">def</span> <span class="nf">_load_image</span><span class="p">(</span><span class="n">stmdata_object</span><span class="p">):</span>
	<span class="c1"># load the image data</span>
	<span class="k">if</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">datatype</span> <span class="o">==</span> <span class="s1">&#39;image&#39;</span> <span class="ow">or</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">datatype</span> <span class="o">==</span> <span class="s1">&#39;map&#39;</span><span class="p">:</span>
		<span class="n">stmdata_object</span> <span class="o">=</span> <span class="n">_xr_image</span><span class="p">(</span><span class="n">stmdata_object</span><span class="p">)</span>
	<span class="k">elif</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">datatype</span> <span class="o">==</span> <span class="s1">&#39;line&#39;</span><span class="p">:</span>
		<span class="n">stmdata_object</span> <span class="o">=</span> <span class="n">_xr_image_line</span><span class="p">(</span><span class="n">stmdata_object</span><span class="p">)</span>
	<span class="c1"># add metadata</span>
	<span class="n">stmdata_object</span> <span class="o">=</span> <span class="n">_add_image_metadata</span><span class="p">(</span><span class="n">stmdata_object</span><span class="p">)</span>

	<span class="c1"># make a polynomial background subtraction to the topography data (flatten)</span>
	<span class="k">if</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">loadraw</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
		<span class="n">stmdata_object</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">polyflatten</span><span class="p">(</span><span class="n">stmdata_object</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="n">polyorder</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
	<span class="k">return</span> <span class="n">stmdata_object</span>


<span class="k">def</span> <span class="nf">_xr_map_iv</span><span class="p">(</span><span class="n">stmdata_object</span><span class="p">):</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	TODO need to change spectrum rearranging for the case where alternate is False</span>

<span class="sd">	Create a DataSet containing the Lock-In (LIA) and Current spectroscopy data</span>
<span class="sd">	Use the absolute values of the tip positions as coordinates</span>

<span class="sd">	In spym the spectroscopy data is loaded into an array,</span>
<span class="sd">	which has axis=0 the number of datapoints in the spectra</span>
<span class="sd">	and axis=1 the number of spectra in total.</span>

<span class="sd">	When rearranging, the number of repetitions within each tip position is assumed to be 1</span>
<span class="sd">	and alternate scan direction is assumed to be turned on.</span>
<span class="sd">	These options can be changed by the parameters, `repetitions` and `alternate`</span>
<span class="sd">	&quot;&quot;&quot;</span>

	<span class="c1"># extract the numpy array containing the LIA data from the spym object</span>
	<span class="n">specarray</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">LIA_Current</span><span class="o">.</span><span class="n">data</span>
	<span class="c1"># extract the numpy array containing the Current data from the spym object</span>
	<span class="n">currentarray</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">data</span>

	<span class="c1"># total number of spectra in one postion of the tip</span>
	<span class="n">numberofspectra</span> <span class="o">=</span> <span class="p">(</span><span class="n">stmdata_object</span><span class="o">.</span><span class="n">alternate</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">stmdata_object</span><span class="o">.</span><span class="n">repetitions</span>
	<span class="c1"># size of the map in mapsize x mapsize</span>
	<span class="n">mapsize</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">specarray</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">numberofspectra</span><span class="p">))</span>

	<span class="c1"># reshape LIA data</span>
	<span class="c1"># collect all spectra measured in the same `X, Y` coordinate into an axis (last) of an array.</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">specarray</span><span class="p">,</span> <span class="p">(</span><span class="n">specarray</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">numberofspectra</span><span class="p">),</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">)</span>
	<span class="c1"># Every other spectrum is a forward and backward scan in bias sweep. Separate the forward and backward scans into differing arrays by slicing.</span>
	<span class="c1"># These are all the forward and backward bias sweep spectra, arranged along axis=1, with axis=2 being the repetitions</span>
	<span class="n">spec_fw</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>
	<span class="n">spec_bw</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>
	<span class="c1"># reshape the forward and backward parts into a map</span>
	<span class="n">speccmap_fw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">spec_fw</span><span class="p">,</span> <span class="p">(</span><span class="n">spec_fw</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mapsize</span><span class="p">,</span> <span class="n">mapsize</span><span class="p">,</span> <span class="n">spec_fw</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">)</span>
	<span class="n">speccmap_bw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">spec_bw</span><span class="p">,</span> <span class="p">(</span><span class="n">spec_bw</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mapsize</span><span class="p">,</span> <span class="n">mapsize</span><span class="p">,</span> <span class="n">spec_bw</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">)</span>
	
	<span class="c1"># The last axis (in this case with length of 1) contains the repeated scans in one particular pixel.</span>
	<span class="c1"># If the `repetitions` variable is set to greater than 1, this will contains the repeated spectra within an `X, Y` pixel.</span>

	<span class="c1"># need to flip the x and y axes so that the spectra line up with the topography image.</span>
	<span class="c1"># Meaning the first topo pixel in both directions is also the first spectroscopy pixel in each direction.</span>
	<span class="n">liafw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">speccmap_fw</span><span class="p">)</span>
	<span class="n">liabw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">speccmap_bw</span><span class="p">)</span>

	<span class="c1"># reshape Current data</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">currentarray</span><span class="p">,</span> <span class="p">(</span><span class="n">currentarray</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">numberofspectra</span><span class="p">),</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">)</span>
	<span class="c1"># Every other spectrum is a forward and backward scan in bias sweep. Separate the forward and backward scans into differing arrays by slicing.</span>
	<span class="c1"># These are all the forward and backward bias sweep spectra, arranged along axis=1, with axis=2 being the repetitions</span>
	<span class="n">current_fw</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>
	<span class="n">current_bw</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>
	<span class="c1"># reshape the forward and backward parts into a map</span>
	<span class="n">currentmap_fw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">current_fw</span><span class="p">,</span> <span class="p">(</span><span class="n">current_fw</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mapsize</span><span class="p">,</span> <span class="n">mapsize</span><span class="p">,</span> <span class="n">current_fw</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">)</span>
	<span class="n">currentmap_bw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">current_bw</span><span class="p">,</span> <span class="p">(</span><span class="n">current_bw</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mapsize</span><span class="p">,</span> <span class="n">mapsize</span><span class="p">,</span> <span class="n">current_bw</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">)</span>
	
	<span class="c1"># The last axis (in this case with length of 1) contains the repeated scans in one particular pixel.</span>
	<span class="c1"># If the `repetitions` variable is set to greater than 1, this will contains the repeated spectra within an `X, Y` pixel.</span>

	<span class="c1"># need to flip the x and y axes so that the spectra line up with the topography image.</span>
	<span class="c1"># Meaning the first topo pixel in both directions is also the first spectroscopy pixel in each direction.</span>
	<span class="n">currentfw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">currentmap_fw</span><span class="p">)</span>
	<span class="n">currentbw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">currentmap_bw</span><span class="p">)</span>

	<span class="c1"># Coordinates of the spectroscopy map</span>
	
	<span class="c1"># &#39;RHK_SpecDrift_Xcoord&#39; are the coordinates of the spectra.</span>
	<span class="c1"># This contains the coordinates in the order that the spectra are in. </span>
	<span class="n">xcoo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">LIA_Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_SpecDrift_Xcoord&#39;</span><span class="p">])</span>
	<span class="n">ycoo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">LIA_Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_SpecDrift_Ycoord&#39;</span><span class="p">])</span>
	
	<span class="c1"># reshaping the spectra positions similarly to the spectra.</span>
	<span class="n">meshx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">xcoo</span><span class="p">,</span> <span class="p">(</span><span class="n">mapsize</span><span class="p">,</span> <span class="n">mapsize</span><span class="p">,</span> <span class="n">numberofspectra</span><span class="p">),</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">)[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span>
	<span class="n">meshy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">ycoo</span><span class="p">,</span> <span class="p">(</span><span class="n">mapsize</span><span class="p">,</span> <span class="n">mapsize</span><span class="p">,</span> <span class="n">numberofspectra</span><span class="p">),</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">)[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span>
	
	<span class="c1"># make coordinates for the spectra positions</span>
	<span class="c1"># calculate the pixel size, distance between the neighboring spectra</span>
	<span class="n">pixelsizex</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;size_x&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">mapsize</span>
	<span class="n">pixelsizey</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;size_y&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">mapsize</span>
	<span class="c1"># make coordinates for the spectra positions</span>
	<span class="n">tempx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">pixelsizex</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;size_x&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">pixelsizex</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">mapsize</span><span class="p">)</span> <span class="o">+</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;xoffset&#39;</span><span class="p">]</span>
	<span class="n">tempy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">pixelsizey</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;size_y&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">pixelsizey</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">mapsize</span><span class="p">)</span> <span class="o">+</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;yoffset&#39;</span><span class="p">]</span>

	<span class="c1"># Constructing the xarray DataSet </span>
	<span class="c1"># stacking the forward and backward bias sweeps and using the scandir coordinate</span>
	<span class="c1"># also adding specific attributes</span>
	<span class="n">xrspec</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span>
		<span class="n">data_vars</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
			<span class="n">lia</span> <span class="o">=</span> <span class="p">([</span><span class="s1">&#39;bias&#39;</span><span class="p">,</span> <span class="s1">&#39;specpos_y&#39;</span><span class="p">,</span> <span class="s1">&#39;specpos_x&#39;</span><span class="p">,</span> <span class="s1">&#39;repetitions&#39;</span><span class="p">,</span> <span class="s1">&#39;biasscandir&#39;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">liafw</span><span class="p">,</span> <span class="n">liabw</span><span class="p">),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">12</span><span class="p">),</span>
			<span class="n">current</span> <span class="o">=</span> <span class="p">([</span><span class="s1">&#39;bias&#39;</span><span class="p">,</span> <span class="s1">&#39;specpos_y&#39;</span><span class="p">,</span> <span class="s1">&#39;specpos_x&#39;</span><span class="p">,</span> <span class="s1">&#39;repetitions&#39;</span><span class="p">,</span> <span class="s1">&#39;biasscandir&#39;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">currentfw</span><span class="p">,</span> <span class="n">currentbw</span><span class="p">),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">12</span><span class="p">),</span>
			<span class="n">x</span> <span class="o">=</span> <span class="p">([</span><span class="s1">&#39;specpos_y&#39;</span><span class="p">,</span> <span class="s1">&#39;specpos_x&#39;</span><span class="p">],</span> <span class="n">meshx</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">9</span><span class="p">),</span>
			<span class="n">y</span> <span class="o">=</span> <span class="p">([</span><span class="s1">&#39;specpos_y&#39;</span><span class="p">,</span> <span class="s1">&#39;specpos_x&#39;</span><span class="p">],</span> <span class="n">meshy</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">9</span><span class="p">)</span>
			<span class="p">),</span>
		<span class="n">coords</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
			<span class="n">bias</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;LIA_Current_x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
			<span class="n">specpos_x</span> <span class="o">=</span> <span class="n">tempx</span><span class="p">,</span>
			<span class="n">specpos_y</span> <span class="o">=</span> <span class="n">tempy</span><span class="p">,</span>
			<span class="n">repetitions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">stmdata_object</span><span class="o">.</span><span class="n">repetitions</span><span class="p">)),</span>
			<span class="n">biasscandir</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="s1">&#39;right&#39;</span><span class="p">],</span> <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;U&#39;</span><span class="p">)</span>
			<span class="p">),</span>
		<span class="n">attrs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">filename</span> <span class="o">=</span> <span class="n">_get_filename</span><span class="p">(</span><span class="n">stmdata_object</span><span class="o">.</span><span class="n">filename</span><span class="p">))</span>
	<span class="p">)</span>

	<span class="n">xrspec</span><span class="p">[</span><span class="s1">&#39;lia&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;pA&#39;</span>
	<span class="n">xrspec</span><span class="p">[</span><span class="s1">&#39;lia&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;picoampere&#39;</span>
	<span class="n">xrspec</span><span class="p">[</span><span class="s1">&#39;current&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;pA&#39;</span>
	<span class="n">xrspec</span><span class="p">[</span><span class="s1">&#39;current&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;picoampere&#39;</span>
	<span class="n">xrspec</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nm&#39;</span>
	<span class="n">xrspec</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nanometer&#39;</span>
	<span class="n">xrspec</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nm&#39;</span>
	<span class="n">xrspec</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nanometer&#39;</span>
	<span class="n">xrspec</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;bias&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;V&#39;</span>
	<span class="n">xrspec</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;bias&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Volt&#39;</span>
	<span class="n">xrspec</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;specpos_x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nm&#39;</span>
	<span class="n">xrspec</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;specpos_y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nm&#39;</span>
	<span class="n">xrspec</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;specpos_x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nanometer&#39;</span>
	<span class="n">xrspec</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;specpos_y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nanometer&#39;</span>

	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span> <span class="o">=</span> <span class="n">xrspec</span>
	<span class="k">return</span> <span class="n">stmdata_object</span>


<span class="k">def</span> <span class="nf">_xr_line_iv</span><span class="p">(</span><span class="n">stmdata_object</span><span class="p">):</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Create a DataSet containing the Lock-In (LIA) and Current spectroscopy data</span>
<span class="sd">	Use the absolute values of the tip positions as coordinates</span>

<span class="sd">	In spym the spectroscopy data is loaded into an array,</span>
<span class="sd">	which has axis=0 the number of datapoints in the spectra</span>
<span class="sd">	and axis=1 the number of spectra in total.</span>

<span class="sd">	When rearranging, the number of repetitions within each tip position is assumed to be 1</span>
<span class="sd">	and alternate scan direction is assumed to be turned on.</span>
<span class="sd">	These options can be changed by the parameters, `repetitions` and `alternate`</span>
<span class="sd">	&quot;&quot;&quot;</span>

	<span class="c1"># extract the numpy array containing the LIA data from the spym object</span>
	<span class="n">specarray</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">LIA_Current</span><span class="o">.</span><span class="n">data</span>
	<span class="c1"># extract the numpy array containing the Current data from the spym object</span>
	<span class="n">currentarray</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">data</span>

	<span class="c1"># total number of spectra in one postion of the tip</span>
	<span class="n">numberofspectra</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">stmdata_object</span><span class="o">.</span><span class="n">alternate</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">stmdata_object</span><span class="o">.</span><span class="n">repetitions</span><span class="p">)</span>
	<span class="c1"># size of the line, the number of the different physical positions of the tip</span>
	<span class="n">linesize</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">specarray</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">numberofspectra</span><span class="p">)</span>

	<span class="c1"># reshape LIA data</span>
	<span class="c1"># Every other spectrum is a forward and backward scan in bias sweep. Separate the forward and backward scans into differing arrays by slicing.</span>
	<span class="c1"># These are all the forward and backward bias sweep spectra, arranged along axis=1, with axis=2 being the repetitions</span>
	<span class="n">templia</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">specarray</span><span class="p">,</span> <span class="p">(</span><span class="n">specarray</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">numberofspectra</span><span class="p">),</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">)</span>
	<span class="n">liafw</span> <span class="o">=</span> <span class="n">templia</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>
	<span class="n">liabw</span> <span class="o">=</span> <span class="n">templia</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>

	<span class="c1"># reshape Current data</span>
	<span class="n">tempcurr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">currentarray</span><span class="p">,</span> <span class="p">(</span><span class="n">currentarray</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">numberofspectra</span><span class="p">),</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">)</span>
	<span class="n">currentfw</span> <span class="o">=</span> <span class="n">tempcurr</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>
	<span class="n">currentbw</span> <span class="o">=</span> <span class="n">tempcurr</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>

	<span class="c1"># Coordinates of the spectroscopy map</span>
	<span class="c1"># &#39;RHK_SpecDrift_Xcoord&#39; are the coordinates of the spectra.</span>
	<span class="c1"># This contains the coordinates in the order that the spectra are in. </span>
	<span class="n">xcoo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">LIA_Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_SpecDrift_Xcoord&#39;</span><span class="p">])</span>
	<span class="n">ycoo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">LIA_Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_SpecDrift_Ycoord&#39;</span><span class="p">])</span>
	<span class="c1"># reshaping the coordinates similarly to the spectra. Need only every nth coordinate, where n is then number of spectra in a tip position</span>
	<span class="n">tempx</span> <span class="o">=</span> <span class="n">xcoo</span><span class="p">[</span><span class="mi">0</span><span class="p">::</span><span class="n">numberofspectra</span><span class="p">]</span>
	<span class="n">tempy</span> <span class="o">=</span> <span class="n">ycoo</span><span class="p">[</span><span class="mi">0</span><span class="p">::</span><span class="n">numberofspectra</span><span class="p">]</span>
	<span class="n">linelength</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">tempx</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">tempx</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">tempy</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">tempy</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
	<span class="c1"># distance coordinates along the line in [nm]</span>
	<span class="n">linecoord</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">linelength</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">tempx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">9</span>

<span class="w">	</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Constructing the xarray Dataset </span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="c1"># stacking the forward and backward bias sweeps and using the scandir coordinate</span>
	<span class="c1"># also adding specific attributes</span>
	<span class="n">xrspec</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span>
		<span class="n">data_vars</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
			<span class="n">lia</span> <span class="o">=</span> <span class="p">([</span><span class="s1">&#39;bias&#39;</span><span class="p">,</span> <span class="s1">&#39;dist&#39;</span><span class="p">,</span> <span class="s1">&#39;repetitions&#39;</span><span class="p">,</span> <span class="s1">&#39;biasscandir&#39;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">liafw</span><span class="p">,</span> <span class="n">liabw</span><span class="p">),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">12</span><span class="p">),</span>
			<span class="n">current</span> <span class="o">=</span> <span class="p">([</span><span class="s1">&#39;bias&#39;</span><span class="p">,</span> <span class="s1">&#39;dist&#39;</span><span class="p">,</span> <span class="s1">&#39;repetitions&#39;</span><span class="p">,</span> <span class="s1">&#39;biasscandir&#39;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">currentfw</span><span class="p">,</span> <span class="n">currentbw</span><span class="p">),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">12</span><span class="p">),</span>
			<span class="n">x</span> <span class="o">=</span> <span class="p">([</span><span class="s1">&#39;dist&#39;</span><span class="p">],</span> <span class="n">tempx</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">9</span><span class="p">),</span>
			<span class="n">y</span> <span class="o">=</span> <span class="p">([</span><span class="s1">&#39;dist&#39;</span><span class="p">],</span> <span class="n">tempy</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">9</span><span class="p">)</span>
			<span class="p">),</span>
		<span class="n">coords</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
			<span class="n">bias</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;LIA_Current_x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
			<span class="n">dist</span> <span class="o">=</span> <span class="n">linecoord</span><span class="p">,</span>
			<span class="n">repetitions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">stmdata_object</span><span class="o">.</span><span class="n">repetitions</span><span class="p">)),</span>
			<span class="n">biasscandir</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="s1">&#39;right&#39;</span><span class="p">],</span> <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;U&#39;</span><span class="p">)</span>
			<span class="p">),</span>
		<span class="n">attrs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">filename</span> <span class="o">=</span> <span class="n">_get_filename</span><span class="p">(</span><span class="n">stmdata_object</span><span class="o">.</span><span class="n">filename</span><span class="p">))</span>
	<span class="p">)</span>

	<span class="n">xrspec</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;dist&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nm&#39;</span>
	<span class="n">xrspec</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;dist&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nanometer&#39;</span>
	<span class="n">xrspec</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;bias&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;V&#39;</span>
	<span class="n">xrspec</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;bias&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Volt&#39;</span>

	<span class="n">xrspec</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nm&#39;</span>
	<span class="n">xrspec</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nm&#39;</span>
	<span class="n">xrspec</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nanometer&#39;</span>
	<span class="n">xrspec</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nanometer&#39;</span>
	<span class="n">xrspec</span><span class="p">[</span><span class="s1">&#39;lia&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;pA&#39;</span>
	<span class="n">xrspec</span><span class="p">[</span><span class="s1">&#39;lia&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;picoampere&#39;</span>
	<span class="n">xrspec</span><span class="p">[</span><span class="s1">&#39;current&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;pA&#39;</span>
	<span class="n">xrspec</span><span class="p">[</span><span class="s1">&#39;current&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;picoampere&#39;</span>

	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span> <span class="o">=</span> <span class="n">xrspec</span>
	<span class="k">return</span> <span class="n">stmdata_object</span>


<span class="k">def</span> <span class="nf">_xr_spec_iv</span><span class="p">(</span><span class="n">stmdata_object</span><span class="p">):</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Create a DataSet containing the Lock-In (LIA) and Current spectroscopy data</span>
<span class="sd">	Use the absolute values of the tip positions are in the attributes</span>
<span class="sd">	&quot;&quot;&quot;</span>

	<span class="c1"># extract the numpy array containing the LIA data from the spym object</span>
	<span class="n">specarray</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">LIA_Current</span><span class="o">.</span><span class="n">data</span>
	<span class="c1"># extract the numpy array containing the Current data from the spym object</span>
	<span class="n">currentarray</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">data</span>

	<span class="c1"># reshape LIA data</span>
	<span class="c1"># Every other spectrum is a forward and backward scan in bias sweep. Separate the forward and backward scans into differing arrays by slicing.</span>
	<span class="n">liafw</span> <span class="o">=</span> <span class="n">specarray</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>
	<span class="n">liabw</span> <span class="o">=</span> <span class="n">specarray</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>

	<span class="c1"># reshape Current data</span>
	<span class="n">currentfw</span> <span class="o">=</span> <span class="n">currentarray</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>
	<span class="n">currentbw</span> <span class="o">=</span> <span class="n">currentarray</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>

	<span class="c1"># Coordinates of the spectroscopy map</span>
	<span class="c1"># &#39;RHK_SpecDrift_Xcoord&#39; are the coordinates of the spectra.</span>
	<span class="c1"># This contains the coordinates in the order that the spectra are in. </span>
	<span class="c1"># Here we only need the first x and y components</span>
	<span class="n">xcoo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">LIA_Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_SpecDrift_Xcoord&#39;</span><span class="p">])</span>
	<span class="n">ycoo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">LIA_Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_SpecDrift_Ycoord&#39;</span><span class="p">])</span>
	<span class="c1"># reshaping the coordinates similarly to the spectra.</span>
	<span class="n">tempx</span> <span class="o">=</span> <span class="n">xcoo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
	<span class="n">tempy</span> <span class="o">=</span> <span class="n">ycoo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

	<span class="c1"># Constructing the xarray Dataset </span>
	<span class="c1"># stacking the forward and backward bias sweeps and using the scandir coordinate</span>
	<span class="c1"># also adding specific attributes</span>
	<span class="n">xrspec</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span>
		<span class="n">data_vars</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
			<span class="n">lia</span> <span class="o">=</span> <span class="p">([</span><span class="s1">&#39;bias&#39;</span><span class="p">,</span> <span class="s1">&#39;repetitions&#39;</span><span class="p">,</span> <span class="s1">&#39;biasscandir&#39;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">liafw</span><span class="p">,</span> <span class="n">liabw</span><span class="p">),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">12</span><span class="p">),</span>
			<span class="n">current</span> <span class="o">=</span> <span class="p">([</span><span class="s1">&#39;bias&#39;</span><span class="p">,</span> <span class="s1">&#39;repetitions&#39;</span><span class="p">,</span> <span class="s1">&#39;biasscandir&#39;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">currentfw</span><span class="p">,</span> <span class="n">currentbw</span><span class="p">),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">12</span><span class="p">),</span>
			<span class="n">x</span> <span class="o">=</span> <span class="n">tempx</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">9</span><span class="p">,</span>
			<span class="n">y</span> <span class="o">=</span> <span class="n">tempy</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">9</span>
			<span class="p">),</span>
		<span class="n">coords</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
			<span class="n">bias</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;LIA_Current_x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
			<span class="n">repetitions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">stmdata_object</span><span class="o">.</span><span class="n">repetitions</span><span class="p">)),</span>
			<span class="n">biasscandir</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="s1">&#39;right&#39;</span><span class="p">],</span> <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;U&#39;</span><span class="p">)</span>
			<span class="p">),</span>
		<span class="n">attrs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">filename</span> <span class="o">=</span> <span class="n">_get_filename</span><span class="p">(</span><span class="n">stmdata_object</span><span class="o">.</span><span class="n">filename</span><span class="p">))</span>
	<span class="p">)</span>

	<span class="n">xrspec</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;bias&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;V&#39;</span>
	<span class="n">xrspec</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;bias&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Volt&#39;</span>

	<span class="n">xrspec</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;speccoord_x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tempx</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">9</span>
	<span class="n">xrspec</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;speccoord_y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tempy</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">9</span>
	<span class="n">xrspec</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;speccoord_x units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nm&#39;</span>
	<span class="n">xrspec</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;speccoord_y units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nm&#39;</span>

	<span class="n">xrspec</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nm&#39;</span>
	<span class="n">xrspec</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nm&#39;</span>
	<span class="n">xrspec</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nanometer&#39;</span>
	<span class="n">xrspec</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nanometer&#39;</span>
	<span class="n">xrspec</span><span class="p">[</span><span class="s1">&#39;lia&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;pA&#39;</span>
	<span class="n">xrspec</span><span class="p">[</span><span class="s1">&#39;lia&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;picoampere&#39;</span>
	<span class="n">xrspec</span><span class="p">[</span><span class="s1">&#39;current&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;pA&#39;</span>
	<span class="n">xrspec</span><span class="p">[</span><span class="s1">&#39;current&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;picoampere&#39;</span>

	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span> <span class="o">=</span> <span class="n">xrspec</span>
	<span class="k">return</span> <span class="n">stmdata_object</span>


<span class="k">def</span> <span class="nf">_xr_map_iz</span><span class="p">(</span><span class="n">stmdata_object</span><span class="p">):</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	TODO need to change spectrum rearranging for the case where alternate is False</span>

<span class="sd">	Create a DataSet containing the Lock-In (LIA) and Current spectroscopy data</span>
<span class="sd">	Use the absolute values of the tip positions as coordinates</span>

<span class="sd">	In spym the spectroscopy data is loaded into an array,</span>
<span class="sd">	which has axis=0 the number of datapoints in the spectra</span>
<span class="sd">	and axis=1 the number of spectra in total.</span>

<span class="sd">	When rearranging, the number of repetitions within each tip position is assumed to be 1</span>
<span class="sd">	and alternate scan direction is assumed to be turned on.</span>
<span class="sd">	These options can be changed by the parameters, `repetitions` and `alternate`</span>
<span class="sd">	&quot;&quot;&quot;</span>

	<span class="c1"># extract the numpy array containing the Current data from the spym object</span>
	<span class="n">currentarray</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">data</span>

	<span class="c1"># total number of spectra in one postion of the tip</span>
	<span class="n">numberofspectra</span> <span class="o">=</span> <span class="p">(</span><span class="n">stmdata_object</span><span class="o">.</span><span class="n">alternate</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">stmdata_object</span><span class="o">.</span><span class="n">repetitions</span>
	<span class="c1"># size of the map in mapsize x mapsize</span>
	<span class="n">mapsize</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">currentarray</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">numberofspectra</span><span class="p">))</span>

	<span class="c1"># reshape Current data</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">currentarray</span><span class="p">,</span> <span class="p">(</span><span class="n">currentarray</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">numberofspectra</span><span class="p">),</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">)</span>
	<span class="c1"># Every other spectrum is a forward and backward scan in bias sweep. Separate the forward and backward scans into differing arrays by slicing.</span>
	<span class="c1"># These are all the forward and backward bias sweep spectra, arranged along axis=1, with axis=2 being the repetitions</span>
	<span class="n">current_fw</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>
	<span class="n">current_bw</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>
	<span class="c1"># reshape the forward and backward parts into a map</span>
	<span class="n">currentmap_fw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">current_fw</span><span class="p">,</span> <span class="p">(</span><span class="n">current_fw</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mapsize</span><span class="p">,</span> <span class="n">mapsize</span><span class="p">,</span> <span class="n">current_fw</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">)</span>
	<span class="n">currentmap_bw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">current_bw</span><span class="p">,</span> <span class="p">(</span><span class="n">current_bw</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mapsize</span><span class="p">,</span> <span class="n">mapsize</span><span class="p">,</span> <span class="n">current_bw</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">)</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	The last axis (in this case with length of 1) contains the repeated scans in one particular pixel.</span>
<span class="sd">	If the `repetitions` variable is set to greater than 1, this will contains the repeated spectra within an `X, Y` pixel.</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="n">currentfw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">currentmap_fw</span><span class="p">)</span>
	<span class="n">currentbw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">currentmap_bw</span><span class="p">)</span>

<span class="w">	</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Coordinates of the spectroscopy map</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="c1"># &#39;RHK_SpecDrift_Xcoord&#39; are the coordinates of the spectra.</span>
	<span class="c1"># This contains the coordinates in the order that the spectra are in. </span>
	<span class="n">xcoo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_SpecDrift_Xcoord&#39;</span><span class="p">])</span>
	<span class="n">ycoo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_SpecDrift_Ycoord&#39;</span><span class="p">])</span>
	<span class="c1"># reshaping the spectra positions similarly to the spectra.</span>
	<span class="n">meshx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">xcoo</span><span class="p">,</span> <span class="p">(</span><span class="n">mapsize</span><span class="p">,</span> <span class="n">mapsize</span><span class="p">,</span> <span class="n">numberofspectra</span><span class="p">),</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">)[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span>
	<span class="n">meshy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">ycoo</span><span class="p">,</span> <span class="p">(</span><span class="n">mapsize</span><span class="p">,</span> <span class="n">mapsize</span><span class="p">,</span> <span class="n">numberofspectra</span><span class="p">),</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">)[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span>
	
	<span class="c1"># make coordinates for the spectra positions</span>
	<span class="c1"># calculate the pixel size, distance between the neighboring spectra</span>
	<span class="n">pixelsizex</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;size_x&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">mapsize</span>
	<span class="n">pixelsizey</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;size_y&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">mapsize</span>
	<span class="c1"># make coordinates for the spectra positions</span>
	<span class="n">tempx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">pixelsizex</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;size_x&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">pixelsizex</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">mapsize</span><span class="p">)</span> <span class="o">+</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;xoffset&#39;</span><span class="p">]</span>
	<span class="n">tempy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">pixelsizey</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;size_y&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">pixelsizey</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">mapsize</span><span class="p">)</span> <span class="o">+</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;yoffset&#39;</span><span class="p">]</span>

<span class="w">	</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Constructing the xarray DataSet </span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="c1"># stacking the forward and backward bias sweeps and using the scandir coordinate</span>
	<span class="c1"># also adding specific attributes</span>
	<span class="n">xrspec</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span>
		<span class="n">data_vars</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
			<span class="n">current</span> <span class="o">=</span> <span class="p">([</span><span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="s1">&#39;specpos_x&#39;</span><span class="p">,</span> <span class="s1">&#39;specpos_y&#39;</span><span class="p">,</span> <span class="s1">&#39;repetitions&#39;</span><span class="p">,</span> <span class="s1">&#39;zscandir&#39;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">currentfw</span><span class="p">,</span> <span class="n">currentbw</span><span class="p">),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">12</span><span class="p">),</span>
			<span class="n">x</span> <span class="o">=</span> <span class="p">([</span><span class="s1">&#39;specpos_x&#39;</span><span class="p">,</span> <span class="s1">&#39;specpos_y&#39;</span><span class="p">],</span> <span class="n">meshx</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">9</span><span class="p">),</span>
			<span class="n">y</span> <span class="o">=</span> <span class="p">([</span><span class="s1">&#39;specpos_x&#39;</span><span class="p">,</span> <span class="s1">&#39;specpos_y&#39;</span><span class="p">],</span> <span class="n">meshy</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">9</span><span class="p">)</span>
			<span class="p">),</span>
		<span class="n">coords</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
			<span class="n">z</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;Current_x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">9</span><span class="p">,</span>
			<span class="n">specpos_x</span> <span class="o">=</span> <span class="n">tempx</span><span class="p">,</span>
			<span class="n">specpos_y</span> <span class="o">=</span> <span class="n">tempy</span><span class="p">,</span>
			<span class="n">repetitions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">stmdata_object</span><span class="o">.</span><span class="n">repetitions</span><span class="p">)),</span>
			<span class="n">zscandir</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="s1">&#39;up&#39;</span><span class="p">,</span> <span class="s1">&#39;down&#39;</span><span class="p">],</span> <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;U&#39;</span><span class="p">)</span>
			<span class="p">),</span>
		<span class="n">attrs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">filename</span> <span class="o">=</span> <span class="n">_get_filename</span><span class="p">(</span><span class="n">stmdata_object</span><span class="o">.</span><span class="n">filename</span><span class="p">))</span>
	<span class="p">)</span>

	<span class="n">xrspec</span><span class="p">[</span><span class="s1">&#39;current&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;pA&#39;</span>
	<span class="n">xrspec</span><span class="p">[</span><span class="s1">&#39;current&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;picoampere&#39;</span>
	<span class="n">xrspec</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nm&#39;</span>
	<span class="n">xrspec</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nanometer&#39;</span>
	<span class="n">xrspec</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nm&#39;</span>
	<span class="n">xrspec</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nanometer&#39;</span>
	<span class="n">xrspec</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nm&#39;</span>
	<span class="n">xrspec</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nanometer&#39;</span>
	<span class="n">xrspec</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;specpos_x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nm&#39;</span>
	<span class="n">xrspec</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;specpos_y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nm&#39;</span>
	<span class="n">xrspec</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;specpos_x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nanometer&#39;</span>
	<span class="n">xrspec</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;specpos_y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nanometer&#39;</span>

	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span> <span class="o">=</span> <span class="n">xrspec</span>
	<span class="k">return</span> <span class="n">stmdata_object</span>


<span class="k">def</span> <span class="nf">_xr_line_iz</span><span class="p">(</span><span class="n">stmdata_object</span><span class="p">):</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Create a DataSet containing the Lock-In (LIA) and Current spectroscopy data</span>
<span class="sd">	Use the absolute values of the tip positions as coordinates</span>

<span class="sd">	In spym the spectroscopy data is loaded into an array,</span>
<span class="sd">	which has axis=0 the number of datapoints in the spectra</span>
<span class="sd">	and axis=1 the number of spectra in total.</span>

<span class="sd">	When rearranging, the number of repetitions within each tip position is assumed to be 1</span>
<span class="sd">	and alternate scan direction is assumed to be turned on.</span>
<span class="sd">	These options can be changed by the parameters, `repetitions` and `alternate`</span>
<span class="sd">	&quot;&quot;&quot;</span>

	<span class="c1"># extract the numpy array containing the Current data from the spym object</span>
	<span class="n">currentarray</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">data</span>

	<span class="c1"># total number of spectra in one postion of the tip</span>
	<span class="n">numberofspectra</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">stmdata_object</span><span class="o">.</span><span class="n">alternate</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">stmdata_object</span><span class="o">.</span><span class="n">repetitions</span><span class="p">)</span>
	<span class="c1"># size of the line, the number of the different physical positions of the tip</span>
	<span class="n">linesize</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">currentarray</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">numberofspectra</span><span class="p">)</span>

	<span class="c1"># reshape Current data</span>
	<span class="n">tempcurr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">currentarray</span><span class="p">,</span> <span class="p">(</span><span class="n">currentarray</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">numberofspectra</span><span class="p">),</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">)</span>
	<span class="n">currentfw</span> <span class="o">=</span> <span class="n">tempcurr</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>
	<span class="n">currentbw</span> <span class="o">=</span> <span class="n">tempcurr</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>

<span class="w">	</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Coordinates of the spectroscopy map</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="c1"># &#39;RHK_SpecDrift_Xcoord&#39; are the coordinates of the spectra.</span>
	<span class="c1"># This contains the coordinates in the order that the spectra are in. </span>
	<span class="n">xcoo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_SpecDrift_Xcoord&#39;</span><span class="p">])</span>
	<span class="n">ycoo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_SpecDrift_Ycoord&#39;</span><span class="p">])</span>
	<span class="c1"># reshaping the coordinates similarly to the spectra. Need only every nth coordinate, where n is the number of spectra in a position</span>
	<span class="n">tempx</span> <span class="o">=</span> <span class="n">xcoo</span><span class="p">[</span><span class="mi">0</span><span class="p">::</span><span class="n">numberofspectra</span><span class="p">]</span>
	<span class="n">tempy</span> <span class="o">=</span> <span class="n">ycoo</span><span class="p">[</span><span class="mi">0</span><span class="p">::</span><span class="n">numberofspectra</span><span class="p">]</span>
	<span class="n">linelength</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">tempx</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">tempx</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">tempy</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">tempy</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
	<span class="c1"># distance coordinates along the line in [nm]</span>
	<span class="n">linecoord</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">linelength</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">tempx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">9</span>

<span class="w">	</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Constructing the xarray Dataset </span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="c1"># stacking the forward and backward bias sweeps and using the scandir coordinate</span>
	<span class="c1"># also adding specific attributes</span>
	<span class="n">xrspec</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span>
		<span class="n">data_vars</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
			<span class="n">current</span> <span class="o">=</span> <span class="p">([</span><span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="s1">&#39;dist&#39;</span><span class="p">,</span> <span class="s1">&#39;repetitions&#39;</span><span class="p">,</span> <span class="s1">&#39;zscandir&#39;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">currentfw</span><span class="p">,</span> <span class="n">currentbw</span><span class="p">),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">12</span><span class="p">),</span>
			<span class="n">x</span> <span class="o">=</span> <span class="p">([</span><span class="s1">&#39;dist&#39;</span><span class="p">],</span> <span class="n">tempx</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">9</span><span class="p">),</span>
			<span class="n">y</span> <span class="o">=</span> <span class="p">([</span><span class="s1">&#39;dist&#39;</span><span class="p">],</span> <span class="n">tempy</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">9</span><span class="p">)</span>
			<span class="p">),</span>
		<span class="n">coords</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
			<span class="n">z</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;Current_x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">9</span><span class="p">,</span>
			<span class="n">dist</span> <span class="o">=</span> <span class="n">linecoord</span><span class="p">,</span>
			<span class="n">repetitions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">stmdata_object</span><span class="o">.</span><span class="n">repetitions</span><span class="p">)),</span>
			<span class="n">zscandir</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="s1">&#39;up&#39;</span><span class="p">,</span> <span class="s1">&#39;down&#39;</span><span class="p">],</span> <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;U&#39;</span><span class="p">)</span>
			<span class="p">),</span>
		<span class="n">attrs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">filename</span> <span class="o">=</span> <span class="n">_get_filename</span><span class="p">(</span><span class="n">stmdata_object</span><span class="o">.</span><span class="n">filename</span><span class="p">))</span>
	<span class="p">)</span>

	<span class="n">xrspec</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;dist&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nm&#39;</span>
	<span class="n">xrspec</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;dist&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nanometer&#39;</span>
	<span class="n">xrspec</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nm&#39;</span>
	<span class="n">xrspec</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nanometer&#39;</span>

	<span class="n">xrspec</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nm&#39;</span>
	<span class="n">xrspec</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nm&#39;</span>
	<span class="n">xrspec</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nanometer&#39;</span>
	<span class="n">xrspec</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nanometer&#39;</span>
	<span class="n">xrspec</span><span class="p">[</span><span class="s1">&#39;current&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;pA&#39;</span>
	<span class="n">xrspec</span><span class="p">[</span><span class="s1">&#39;current&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;picoampere&#39;</span>

	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span> <span class="o">=</span> <span class="n">xrspec</span>
	<span class="k">return</span> <span class="n">stmdata_object</span>


<span class="k">def</span> <span class="nf">_xr_spec_iz</span><span class="p">(</span><span class="n">stmdata_object</span><span class="p">):</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Create a DataSet containing the Lock-In (LIA) and Current spectroscopy data</span>
<span class="sd">	Use the absolute values of the tip positions are in the attributes</span>
<span class="sd">	&quot;&quot;&quot;</span>

	<span class="c1"># extract the numpy array containing the Current data from the spym object</span>
	<span class="n">currentarray</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">data</span>

	<span class="c1"># reshape Current data</span>
	<span class="n">currentfw</span> <span class="o">=</span> <span class="n">currentarray</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>
	<span class="n">currentbw</span> <span class="o">=</span> <span class="n">currentarray</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>

<span class="w">	</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Coordinates of the spectroscopy map</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="c1"># &#39;RHK_SpecDrift_Xcoord&#39; are the coordinates of the spectra.</span>
	<span class="c1"># This contains the coordinates in the order that the spectra are in. </span>
	<span class="c1"># Here we only need the first x and y components</span>
	<span class="n">xcoo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_SpecDrift_Xcoord&#39;</span><span class="p">])</span>
	<span class="n">ycoo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_SpecDrift_Ycoord&#39;</span><span class="p">])</span>
	<span class="c1"># reshaping the coordinates similarly to the spectra.</span>
	<span class="n">tempx</span> <span class="o">=</span> <span class="n">xcoo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
	<span class="n">tempy</span> <span class="o">=</span> <span class="n">ycoo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="w">	</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Constructing the xarray Dataset </span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="c1"># stacking the forward and backward bias sweeps and using the scandir coordinate</span>
	<span class="c1"># also adding specific attributes</span>
	<span class="n">xrspec</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span>
		<span class="n">data_vars</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
			<span class="n">current</span> <span class="o">=</span> <span class="p">([</span><span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="s1">&#39;repetitions&#39;</span><span class="p">,</span> <span class="s1">&#39;zscandir&#39;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">currentfw</span><span class="p">,</span> <span class="n">currentbw</span><span class="p">),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">12</span><span class="p">),</span>
			<span class="n">x</span> <span class="o">=</span> <span class="n">tempx</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">9</span><span class="p">,</span>
			<span class="n">y</span> <span class="o">=</span> <span class="n">tempy</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">9</span>
			<span class="p">),</span>
		<span class="n">coords</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
			<span class="n">z</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;Current_x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">9</span><span class="p">,</span>
			<span class="n">repetitions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">stmdata_object</span><span class="o">.</span><span class="n">repetitions</span><span class="p">)),</span>
			<span class="n">zscandir</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="s1">&#39;up&#39;</span><span class="p">,</span> <span class="s1">&#39;down&#39;</span><span class="p">],</span> <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;U&#39;</span><span class="p">)</span>
			<span class="p">),</span>
		<span class="n">attrs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">filename</span> <span class="o">=</span> <span class="n">_get_filename</span><span class="p">(</span><span class="n">stmdata_object</span><span class="o">.</span><span class="n">filename</span><span class="p">))</span>
	<span class="p">)</span>

	<span class="n">xrspec</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nm&#39;</span>
	<span class="n">xrspec</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nm&#39;</span>
	<span class="n">xrspec</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nanometer&#39;</span>
	<span class="n">xrspec</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nanometer&#39;</span>
	<span class="n">xrspec</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;speccoord_x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tempx</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">9</span>
	<span class="n">xrspec</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;speccoord_y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tempy</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">9</span>
	<span class="n">xrspec</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;speccoord_x units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nm&#39;</span>
	<span class="n">xrspec</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;speccoord_y units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nm&#39;</span>
	<span class="n">xrspec</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nm&#39;</span>
	<span class="n">xrspec</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nanometer&#39;</span>
	<span class="n">xrspec</span><span class="p">[</span><span class="s1">&#39;current&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;pA&#39;</span>
	<span class="n">xrspec</span><span class="p">[</span><span class="s1">&#39;current&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;picoampere&#39;</span>

	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span> <span class="o">=</span> <span class="n">xrspec</span>
	<span class="k">return</span> <span class="n">stmdata_object</span>


<span class="k">def</span> <span class="nf">_xr_image</span><span class="p">(</span><span class="n">stmdata_object</span><span class="p">):</span>
	<span class="c1"># topography</span>
	<span class="n">topofw</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Topography_Forward</span>
	<span class="n">topobw</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Topography_Backward</span>
	
	<span class="c1"># Load image data</span>
	<span class="c1"># use spym to align (flatten the data) and planefit</span>
	<span class="c1"># topofw, bg = align(topofw, baseline=&#39;median&#39;)</span>
	<span class="c1"># topobw, bg = align(topobw, baseline=&#39;median&#39;)</span>
	<span class="c1"># topofw, bg = plane(topofw)</span>
	<span class="c1"># topobw, bg = plane(topobw)</span>

	<span class="c1"># current</span>
	<span class="n">currfw</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current_Forward</span>
	<span class="n">currbw</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current_Backward</span>
	<span class="c1"># lia</span>
	<span class="n">liafw</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">LIA_Current_Forward</span>
	<span class="n">liabw</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">LIA_Current_Backward</span>

	<span class="c1"># The image data also needs to be flipped along the slow scan direction,</span>
	<span class="c1"># so that it shows up as the RHK Rev software would display it, when plotting with xarray.plot().</span>
	<span class="c1"># this behaviour is because xarray.plot, uses by default pcolormesh() to plot.</span>
	<span class="c1"># pcolormesh() flips the data along the slow scan direction. imshow() plots it the way it looks in RHK Rev and Gwyddion.</span>
	<span class="n">topofw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">topofw</span><span class="p">)</span>
	<span class="n">topobw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">topobw</span><span class="p">)</span>
	<span class="n">currfw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">currfw</span><span class="p">)</span>
	<span class="n">currbw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">currbw</span><span class="p">)</span>
	<span class="n">liafw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">liafw</span><span class="p">)</span>
	<span class="n">liabw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">liabw</span><span class="p">)</span>

	<span class="c1"># coordinates</span>
	<span class="c1"># absolute values should be found by adding the X Y offsets</span>
	<span class="n">xoff</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Topography_Forward</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_Xoffset&#39;</span><span class="p">]</span>
	<span class="n">yoff</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Topography_Forward</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_Yoffset&#39;</span><span class="p">]</span>

	<span class="c1"># these are the relative coordinates (from 0 to size of the image)</span>
	<span class="n">xx</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Topography_Forward_x</span><span class="o">.</span><span class="n">data</span>
	<span class="n">yy</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Topography_Forward_y</span><span class="o">.</span><span class="n">data</span>

	<span class="c1"># calculate the relative coordinates, including rotation</span>
	<span class="c1"># the offset refers to the corner of the image, so we need to account for that</span>
	<span class="n">xlength</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">xx</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">xx</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
	<span class="n">ylength</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">yy</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">yy</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

	<span class="n">xoff</span> <span class="o">-=</span> <span class="n">xlength</span><span class="o">/</span><span class="mi">2</span>
	<span class="n">yoff</span> <span class="o">-=</span> <span class="n">ylength</span><span class="o">/</span><span class="mi">2</span>

	<span class="c1"># create xarray Dataset of the image data</span>
	<span class="n">xrimage</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span>
		<span class="n">data_vars</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
			<span class="n">topography</span> <span class="o">=</span> <span class="p">([</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;scandir&#39;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">topofw</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">topobw</span><span class="o">.</span><span class="n">data</span><span class="p">),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">9</span><span class="p">),</span>
			<span class="n">current</span> <span class="o">=</span> <span class="p">([</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;scandir&#39;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">currfw</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">currbw</span><span class="o">.</span><span class="n">data</span><span class="p">),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">12</span><span class="p">),</span>
			<span class="n">lia</span> <span class="o">=</span> <span class="p">([</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;scandir&#39;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">liafw</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">liabw</span><span class="o">.</span><span class="n">data</span><span class="p">),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">12</span><span class="p">)</span>
			<span class="p">),</span>
		<span class="n">coords</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
			<span class="n">x</span> <span class="o">=</span> <span class="n">xx</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">9</span><span class="p">,</span>
			<span class="n">y</span> <span class="o">=</span> <span class="n">yy</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">9</span><span class="p">,</span>
			<span class="n">scandir</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="s1">&#39;forward&#39;</span><span class="p">,</span> <span class="s1">&#39;backward&#39;</span><span class="p">])</span>
			<span class="p">),</span>
		<span class="n">attrs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
			<span class="n">filename</span> <span class="o">=</span> <span class="n">_get_filename</span><span class="p">(</span><span class="n">stmdata_object</span><span class="o">.</span><span class="n">filename</span><span class="p">),</span>
			<span class="n">xoffset</span> <span class="o">=</span> <span class="n">xoff</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">9</span><span class="p">,</span>
			<span class="n">yoffset</span> <span class="o">=</span> <span class="n">yoff</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">9</span><span class="p">,</span>
			<span class="n">xoffset_units</span> <span class="o">=</span> <span class="s1">&#39;nm&#39;</span><span class="p">,</span>
			<span class="n">yoffset_units</span> <span class="o">=</span> <span class="s1">&#39;nm&#39;</span>
			<span class="p">)</span>
		<span class="p">)</span>

	<span class="c1"># calculate image size</span>
	<span class="n">pixelsizex</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">xx</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">xx</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
	<span class="n">pixelsizey</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">yy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">yy</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
	<span class="n">xrimage</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;size_x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">((</span><span class="n">xlength</span> <span class="o">+</span> <span class="n">pixelsizex</span><span class="p">)</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">9</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
	<span class="n">xrimage</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;size_y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">((</span><span class="n">ylength</span> <span class="o">+</span> <span class="n">pixelsizey</span><span class="p">)</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">9</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
	<span class="n">xrimage</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;size_x units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nm&#39;</span>
	<span class="n">xrimage</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;size_y units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nm&#39;</span>

	<span class="n">xrimage</span><span class="p">[</span><span class="s1">&#39;topography&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nm&#39;</span>
	<span class="n">xrimage</span><span class="p">[</span><span class="s1">&#39;topography&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nanometer&#39;</span>
	<span class="n">xrimage</span><span class="p">[</span><span class="s1">&#39;lia&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;pA&#39;</span>
	<span class="n">xrimage</span><span class="p">[</span><span class="s1">&#39;lia&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;picoampere&#39;</span>
	<span class="n">xrimage</span><span class="p">[</span><span class="s1">&#39;current&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;pA&#39;</span>
	<span class="n">xrimage</span><span class="p">[</span><span class="s1">&#39;current&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;picoampere&#39;</span>
	<span class="n">xrimage</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nm&#39;</span>
	<span class="n">xrimage</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nm&#39;</span>
	<span class="n">xrimage</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nanometer&#39;</span>
	<span class="n">xrimage</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nanometer&#39;</span>
	<span class="n">xrimage</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;note&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;fast scan direction</span><span class="se">\n</span><span class="s1">&#39;</span>
	<span class="n">xrimage</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;note&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;slow scan direction</span><span class="se">\n</span><span class="s1">&#39;</span>

	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">xrimage</span>
	<span class="k">return</span> <span class="n">stmdata_object</span>


<span class="k">def</span> <span class="nf">_xr_image_line</span><span class="p">(</span><span class="n">stmdata_object</span><span class="p">):</span>
	<span class="c1"># topography</span>
	<span class="n">topofw</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Topography_Forward</span>
	<span class="n">topobw</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Topography_Backward</span>
	
	<span class="c1"># current</span>
	<span class="n">currfw</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current_Forward</span>
	<span class="n">currbw</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current_Backward</span>
	<span class="c1"># lia</span>
	<span class="n">liafw</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">LIA_Current_Forward</span>
	<span class="n">liabw</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">LIA_Current_Backward</span>

	<span class="c1"># The image data also needs to be flipped along the slow scan direction,</span>
	<span class="c1"># so that it shows up as the RHK Rev software would display it, when plotting with xarray.plot().</span>
	<span class="c1"># this behaviour is because xarray.plot, uses by default pcolormesh() to plot.</span>
	<span class="c1"># pcolormesh() flips the data along the slow scan direction. imshow() plots it the way it looks in RHK Rev and Gwyddion.</span>
	<span class="c1"># topofw = np.flipud(topofw)</span>
	<span class="c1"># topobw = np.flipud(topobw)</span>
	<span class="c1"># currfw = np.flipud(currfw)</span>
	<span class="c1"># currbw = np.flipud(currbw)</span>
	<span class="c1"># liafw = np.flipud(liafw)</span>
	<span class="c1"># liabw = np.flipud(liabw)</span>

	<span class="c1"># coordinates</span>
	<span class="c1"># absolute values should be found by adding the X Y offsets</span>
	<span class="n">xoff</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Topography_Forward</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_Xoffset&#39;</span><span class="p">]</span>
	<span class="n">yoff</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Topography_Forward</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_Yoffset&#39;</span><span class="p">]</span>

	<span class="c1"># these are the relative coordinates (from 0 to size of the image)</span>
	<span class="n">xx</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Topography_Forward_x</span><span class="o">.</span><span class="n">data</span>
	<span class="n">yy</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Topography_Forward_y</span><span class="o">.</span><span class="n">data</span>

	<span class="c1"># calculate the relative coordinates, including rotation</span>
	<span class="c1"># the offset refers to the corner of the image, so we need to account for that</span>
	<span class="n">xlength</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">xx</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">xx</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
	<span class="n">ylength</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">yy</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">yy</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

	<span class="n">xoff</span> <span class="o">-=</span> <span class="n">xlength</span><span class="o">/</span><span class="mi">2</span>
	<span class="n">yoff</span> <span class="o">-=</span> <span class="n">ylength</span><span class="o">/</span><span class="mi">2</span>

	<span class="c1"># create xarray Dataset of the image data</span>
	<span class="n">xrimage</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span>
		<span class="n">data_vars</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
			<span class="n">topography</span> <span class="o">=</span> <span class="p">([</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;scandir&#39;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">topofw</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">topobw</span><span class="o">.</span><span class="n">data</span><span class="p">),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">9</span><span class="p">),</span>
			<span class="n">current</span> <span class="o">=</span> <span class="p">([</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;scandir&#39;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">currfw</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">currbw</span><span class="o">.</span><span class="n">data</span><span class="p">),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">12</span><span class="p">),</span>
			<span class="n">lia</span> <span class="o">=</span> <span class="p">([</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;scandir&#39;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">liafw</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">liabw</span><span class="o">.</span><span class="n">data</span><span class="p">),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">12</span><span class="p">)</span>
			<span class="p">),</span>
		<span class="n">coords</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
			<span class="n">y</span> <span class="o">=</span> <span class="n">xx</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">9</span><span class="p">,</span>
			<span class="n">x</span> <span class="o">=</span> <span class="n">yy</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">9</span><span class="p">,</span>
			<span class="n">scandir</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="s1">&#39;forward&#39;</span><span class="p">,</span> <span class="s1">&#39;backward&#39;</span><span class="p">])</span>
			<span class="p">),</span>
		<span class="n">attrs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
			<span class="n">filename</span> <span class="o">=</span> <span class="n">_get_filename</span><span class="p">(</span><span class="n">stmdata_object</span><span class="o">.</span><span class="n">filename</span><span class="p">),</span>
			<span class="n">xoffset</span> <span class="o">=</span> <span class="n">xoff</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">9</span><span class="p">,</span>
			<span class="n">yoffset</span> <span class="o">=</span> <span class="n">yoff</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">9</span><span class="p">,</span>
			<span class="n">xoffset_units</span> <span class="o">=</span> <span class="s1">&#39;nm&#39;</span><span class="p">,</span>
			<span class="n">yoffset_units</span> <span class="o">=</span> <span class="s1">&#39;nm&#39;</span>
			<span class="p">)</span>
		<span class="p">)</span>

	<span class="n">xrimage</span><span class="p">[</span><span class="s1">&#39;topography&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nm&#39;</span>
	<span class="n">xrimage</span><span class="p">[</span><span class="s1">&#39;topography&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nanometer&#39;</span>
	<span class="n">xrimage</span><span class="p">[</span><span class="s1">&#39;lia&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;pA&#39;</span>
	<span class="n">xrimage</span><span class="p">[</span><span class="s1">&#39;lia&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;picoampere&#39;</span>
	<span class="n">xrimage</span><span class="p">[</span><span class="s1">&#39;current&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;pA&#39;</span>
	<span class="n">xrimage</span><span class="p">[</span><span class="s1">&#39;current&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;picoampere&#39;</span>	
	<span class="n">xrimage</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nm&#39;</span>
	<span class="n">xrimage</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nanometer&#39;</span>
	<span class="n">xrimage</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;note&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;fast scan direction</span><span class="se">\n</span><span class="s1">&#39;</span>
	<span class="n">xrimage</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
	<span class="n">xrimage</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;note&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;repetitions of the topography line</span><span class="se">\n</span><span class="s1">&#39;</span>
	

	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">xrimage</span>
	<span class="k">return</span> <span class="n">stmdata_object</span>


<span class="k">def</span> <span class="nf">_add_map_metadata</span><span class="p">(</span><span class="n">stmdata_object</span><span class="p">):</span>
	<span class="k">if</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectype</span> <span class="o">==</span> <span class="s1">&#39;iv&#39;</span><span class="p">:</span>
		<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;lia&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;bias&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;bias&#39;</span><span class="p">]</span>
		<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;lia&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;bias units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;V&#39;</span>
		<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;lia&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;setpoint&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_Current&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">12</span>
		<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;lia&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;setpoint units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;pA&#39;</span>
		<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;lia&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;time_per_point&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;time_per_point&#39;</span><span class="p">]</span>

	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;current&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;bias&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;bias&#39;</span><span class="p">]</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;current&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;bias units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;V&#39;</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;current&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;setpoint&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_Current&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">12</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;current&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;setpoint units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;pA&#39;</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;current&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;time_per_point&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;time_per_point&#39;</span><span class="p">]</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;bias&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;bias&#39;</span><span class="p">]</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;bias units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;V&#39;</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;setpoint&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_Current&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">12</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;setpoint units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;pA&#39;</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;measurement date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_Date&#39;</span><span class="p">]</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;measurement time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_Time&#39;</span><span class="p">]</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;scan angle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Topography_Forward</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_Angle&#39;</span><span class="p">]</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;LI amplitude&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_CH1Drive_Amplitude&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">3</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;LI amplitude unit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;mV&#39;</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;LI frequency&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_CH1Drive_Frequency&#39;</span><span class="p">]</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;LI frequency unit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Hz&#39;</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;LI phase&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_Lockin0_PhaseOffset&#39;</span><span class="p">]</span>

	<span class="c1"># store the data and spectrum type in the attributes</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;datatype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">datatype</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;spectype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectype</span>

	<span class="k">return</span> <span class="n">stmdata_object</span>


<span class="k">def</span> <span class="nf">_add_line_metadata</span><span class="p">(</span><span class="n">stmdata_object</span><span class="p">):</span>
	<span class="k">if</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectype</span> <span class="o">==</span> <span class="s1">&#39;iv&#39;</span><span class="p">:</span>
		<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;lia&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;bias&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;bias&#39;</span><span class="p">]</span>
		<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;lia&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;bias units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;V&#39;</span>
		<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;lia&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;setpoint&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_Current&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">12</span>
		<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;lia&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;setpoint units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;pA&#39;</span>
		<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;lia&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;time_per_point&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;time_per_point&#39;</span><span class="p">]</span>

	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;current&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;bias&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;bias&#39;</span><span class="p">]</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;current&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;bias units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;V&#39;</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;current&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;setpoint&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_Current&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">12</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;current&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;setpoint units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;pA&#39;</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;current&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;time_per_point&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;time_per_point&#39;</span><span class="p">]</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;bias&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;bias&#39;</span><span class="p">]</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;bias units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;V&#39;</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;setpoint&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_Current&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">12</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;setpoint units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;pA&#39;</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;measurement date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_Date&#39;</span><span class="p">]</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;measurement time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_Time&#39;</span><span class="p">]</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;scan angle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Topography_Forward</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_Angle&#39;</span><span class="p">]</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;LI amplitude&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_CH1Drive_Amplitude&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">3</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;LI amplitude unit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;mV&#39;</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;LI frequency&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_CH1Drive_Frequency&#39;</span><span class="p">]</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;LI frequency unit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Hz&#39;</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;LI phase&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_Lockin0_PhaseOffset&#39;</span><span class="p">]</span>

	<span class="c1"># store the data and spectrum type in the attributes</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;datatype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">datatype</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;spectype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectype</span>

	<span class="k">return</span> <span class="n">stmdata_object</span>


<span class="k">def</span> <span class="nf">_add_spec_metadata</span><span class="p">(</span><span class="n">stmdata_object</span><span class="p">):</span>
	<span class="k">if</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectype</span> <span class="o">==</span> <span class="s1">&#39;iv&#39;</span><span class="p">:</span>
		<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;lia&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;bias&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;bias&#39;</span><span class="p">]</span>
		<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;lia&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;bias units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;V&#39;</span>
		<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;lia&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;setpoint&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_Current&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">12</span>
		<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;lia&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;setpoint units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;pA&#39;</span>
		<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;lia&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;time_per_point&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;time_per_point&#39;</span><span class="p">]</span>
		<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;bias&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;V&#39;</span>
		<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;bias&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;volt&#39;</span>
	
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;current&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;bias&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;bias&#39;</span><span class="p">]</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;current&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;bias units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;V&#39;</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;current&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;setpoint&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_Current&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">12</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;current&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;setpoint units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;pA&#39;</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;current&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;time_per_point&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;time_per_point&#39;</span><span class="p">]</span>

	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;bias&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;bias&#39;</span><span class="p">]</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;bias units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;V&#39;</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;setpoint&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_Current&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">12</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;setpoint units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;pA&#39;</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;measurement date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_Date&#39;</span><span class="p">]</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;measurement time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_Time&#39;</span><span class="p">]</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;LI amplitude&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_CH1Drive_Amplitude&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">3</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;LI amplitude unit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;mV&#39;</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;LI frequency&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_CH1Drive_Frequency&#39;</span><span class="p">]</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;LI frequency unit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Hz&#39;</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;LI phase&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Current</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_Lockin0_PhaseOffset&#39;</span><span class="p">]</span>
	
	<span class="c1"># store the data and spectrum type in the attributes</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;datatype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">datatype</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;spectype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectype</span>
	
	<span class="k">return</span> <span class="n">stmdata_object</span>


<span class="k">def</span> <span class="nf">_add_image_metadata</span><span class="p">(</span><span class="n">stmdata_object</span><span class="p">):</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;bias&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Topography_Forward</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_Bias&#39;</span><span class="p">]</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;bias units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;V&#39;</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;setpoint&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Topography_Forward</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_Current&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">12</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;setpoint units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;pA&#39;</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;measurement date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Topography_Forward</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_Date&#39;</span><span class="p">]</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;measurement time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Topography_Forward</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_Time&#39;</span><span class="p">]</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;scan angle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spymdata</span><span class="o">.</span><span class="n">Topography_Forward</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;RHK_Angle&#39;</span><span class="p">]</span>
	
	<span class="c1"># store the data and spectrum type in the attributes</span>
	<span class="c1"># in the case for a map, the datatype value will not be &#39;image&#39;, but &#39;map&#39;</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;datatype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">datatype</span>
	<span class="n">stmdata_object</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;spectype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmdata_object</span><span class="o">.</span><span class="n">spectype</span>

	<span class="k">return</span> <span class="n">stmdata_object</span>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Peter Nemes-Incze.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>